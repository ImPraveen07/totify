<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta property="og:title" content="Totify"><meta property="og:description" content="Listen to music like Spotify. Your music library and more."><meta property="og:image" content="/s512.png"><meta property="og:image:width" content="512"><meta property="og:image:height" content="512"><meta property="og:type" content="website"><meta name="twitter:card" content="summary_large_image">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Totify</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="/s192.png"><link rel="apple-touch-icon" sizes="512x512" href="/s512.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#1db954">

<style>
/* --- MERGED STYLES (Ultra Smooth, Premium Glassmorphism) --- */
:root{
    --spotify-black: #121212;
    --spotify-dark-grey: #181818;
    --spotify-light-grey: #b3b3b3;
    --spotify-green: #1db954;
    --text-faded: #a7a7a7;
    --bg-darker: #000000;
    /* New Glassmorphism Variables */
    --glass-blur: 20px; /* Increased blur for premium feel */
    --glass-border-color: rgba(255, 255, 255, 0.08);
    --transition-premium: 0.35s cubic-bezier(0.25, 0.8, 0.25, 1); /* Apple-like smoothness */
}
* {
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
    /* Apply premium transition curve universally to non-performance-critical changes */
    transition: background-color 0.2s ease, color 0.2s ease, transform var(--transition-premium), opacity 0.2s ease;
}
body{margin:0;font-family:'Inter',sans-serif;background:var(--spotify-black);color:white;min-height:100vh; overflow-x: hidden; -webkit-overflow-scrolling: touch;}
.lock-scroll{overflow:hidden;position:fixed;width:100%;height:100%;}
.main-content{padding-bottom:120px;}
.app-page{display:none;min-height:100vh;}
.app-page.active{display:block;}
.library-header{display:flex;justify-content:space-between;align-items:center;padding:16px;padding-top:50px;font-size:24px;font-weight:700;}
.library-header .title{font-size:24px;font-weight:700;}
.library-filter-tabs{padding:8px 16px;display:flex;gap:10px;}
/* --- LIQUID GLASS: Filter Tabs (New) --- */
.filter-tab{
    padding:8px 16px;
    border-radius:25px;
    font-size:14px;
    cursor:pointer;
    color:white;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid var(--glass-border-color);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
}
.filter-tab.active{
    background: white;
    color: var(--spotify-black);
    border-color: white;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    transform: scale(1.05); /* Subtle emphasis on active */
}
.library-controls{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;font-size:14px;color:var(--text-faded);}
.library-controls i{color:var(--text-faded);margin-right:5px;}
.track-list{list-style:none;padding:0;margin:0;}
.track-item{display:flex;align-items:center;padding:8px 16px;cursor:pointer;transition:background-color 0.1s ease;opacity:1;transform:translateY(0);}
.track-item.show{opacity:1;transform:translateY(0);transition:opacity 0.3s ease-out,transform 0.3s ease-out;}
.track-item:hover{background-color:var(--spotify-dark-grey);}
.track-item.playing .track-info h3{color:var(--spotify-green);}
.track-img{width:50px;height:50px;object-fit:cover;margin-right:12px;border-radius:4px;}
.track-info{flex-grow:1;min-width:0;}
.track-info h3{margin:0;font-size:16px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.track-info p{margin:2px 0 0 0;font-size:13px;color:var(--text-faded);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.track-duration{font-size:13px;color:var(--text-faded);margin-right:15px;}
.artist-item{display:flex;align-items:center;padding:8px 16px;cursor:pointer;transition:background-color 0.1s ease;}
.artist-img{width:60px;height:60px;object-fit:cover;margin-right:12px;border-radius:50%;}
.search-header{padding:16px;padding-top:50px;font-size:24px;font-weight:700;display:flex;justify-content:space-between;align-items:center;}
.search-bar{display:flex;align-items:center;background:white;color:var(--spotify-black);border-radius:6px;margin:0 16px 20px 16px;padding:10px;}
.search-bar i{font-size:18px;margin-right:10px;}
.search-bar input{border:none;outline:none;background:transparent;color:var(--spotify-black);font-size:16px;flex-grow:1;}
.start-browsing{padding:0 16px;}
.browsing-section.hidden{display:none;}
.browsing-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;padding:16px;}
.grid-item{height:100px;border-radius:8px;background:linear-gradient(to bottom right, #4CAF50, #2E8B57);padding:10px;font-weight:700;font-size:16px;overflow:hidden;position:relative;}
/* PLAYER CSS */
/* FIX: Player transition updated for smooth swipe-down */
.expanded-player{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom, rgba(35, 120, 95, 0.9) 0%, var(--bg-darker) 100%);z-index:100;display:flex;flex-direction:column;padding:0;box-sizing:border-box;transition:transform var(--transition-premium),background 0.5s ease;transform:translateY(100%);}
.expanded-player.is-dragging{transition:none;}
.expanded-player.active{transform:translateY(0);}
.player-content-wrapper{flex-grow:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:80px;}
.player-header,.player-details,.progress-container,.controls-row{padding-left:16px;padding-right:16px;width:100%;box-sizing:border-box;}
.player-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-top:20px;position:sticky;top:0;z-index:50;background-color:transparent;transition:background-color 0.3s ease;}
.player-header i{font-size:24px;cursor:pointer;}
.player-header .playlist-indicator{display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--text-faded);}
.player-art-container{display:flex;justify-content:center;align-items:center;padding-top:30px;padding-bottom:30px;padding-left:16px;padding-right:16px;}
.player-art{width:80vw;max-width:350px;aspect-ratio:1 / 1;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.7);transition:all 0.2s ease-out;transform-origin:center center;}
.player-details{margin:0 0 20px 0;display:flex;justify-content:space-between;align-items:flex-end;}
.player-details h2{margin:0;font-size:24px;font-weight:700; white-space: normal; overflow: visible; text-overflow: clip;}
.player-details p{margin:2px 0 0 0;font-size:16px;color:var(--text-faded); white-space: normal; overflow: visible; text-overflow: clip;}
.progress-container{margin-bottom:20px;}
.time-stamps{display:flex;justify-content:space-between;font-size:12px;color:var(--text-faded);margin-top:5px;}
.controls-row{display:flex;justify-content:space-around;align-items:center;font-size:24px;margin-bottom:20px;}
/* --- LIQUID GLASS: Control Buttons --- */
.controls-row button{
    background:none;border:none;color:white;cursor:pointer;padding:10px;outline:none;
    transition: transform 0.1s ease, background-color 0.1s ease;border-radius: 50%;
}
.controls-row button:active {
    background-color: rgba(255, 255, 255, 0.1);
    transform: scale(0.95);
}
.controls-row .main-play{font-size:72px;}
input[type=range]{-webkit-appearance:none;width:100%;height:4px;border-radius:2px;background:#535353;outline:none;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:12px;height:12px;border-radius:50%;background:white;cursor:pointer; visibility: visible;} 
.like-animation { animation: pulse 0.3s ease-in-out; }
@keyframes pulse { 0% { transform: scale(1.0); } 50% { transform: scale(1.2); } 100% { transform: scale(1.0); } }
/* Artist Page Styles */
.artist-banner-area{height:350px;position:relative;background-size:cover;background-position:center;background-repeat:no-repeat;display:flex;flex-direction:column;justify-content:flex-end;color:white;padding-left:16px;padding-right:16px;padding-bottom:10px;box-shadow:inset 0 -150px 70px -50px rgba(0,0,0,0.7);transition:background-image 0.5s ease;}
.artist-details-overlay{padding-top:10px;padding-bottom:20px;display:flex;flex-direction:column;gap:5px;transition:opacity 0.2s ease-out;}
.artist-details-overlay h2{font-size:32px;font-weight:700;margin:0;}
#artistPopularTracks .track-item, .artist-page-track .track-item{ display:grid; grid-template-columns:25px 1fr 40px; gap:15px; padding:8px 16px; }
#artistPopularTracks .track-item .track-img, .artist-page-track .track-item .track-img{display:none;} 
.track-number{font-size:16px;color:var(--text-faded);display:flex;align-items:center;justify-content:center;}
#artistPopularTracks .track-info h3, .artist-page-track .track-info h3 { white-space: normal; overflow: visible; text-overflow: clip; line-height: 1.2;}
#artistPopularTracks .track-info p, .artist-page-track .track-info p{ font-size:13px; color:var(--text-faded); white-space: normal; overflow: visible; text-overflow: clip;}
.track-controls{display:flex;align-items:center;justify-content:flex-end;gap:10px;}
.track-controls i{color:var(--text-faded);font-size:18px;}
.popular-title {padding: 0 16px;font-size: 20px;font-weight: 700;margin-top: 20px;margin-bottom: 0;}
/* Liked Songs Card/Playlist */
.liked-songs-card { display: flex; align-items: center; padding: 8px 16px; cursor: pointer; }
.liked-icon-container { width: 50px; height: 50px; background: linear-gradient(135deg, #4A209B, #9C7CFD); border-radius: 4px; margin-right: 12px; display: flex; justify-content: center; align-items: center; font-size: 24px;}
.liked-songs-info h3 { margin: 0; font-size: 16px; font-weight: 700; }
.liked-songs-info p { margin: 2px 0 0 0; font-size: 13px; color: var(--text-faded); }
.fixed-header-content { padding-top: 50px; background-color: var(--spotify-black); display: flex; align-items: flex-end; padding-bottom: 20px;}
.liked-songs-image { width: 200px; height: 200px; background: linear-gradient(135deg, #4A209B, #9C7CFD); margin: 0 16px; box-shadow: 0 4px 60px rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; font-size: 96px;}
.playlist-content-scroll-layer { position: relative; z-index: 1; background: var(--spotify-black); padding-top: 20px; min-height: 50vh; padding-bottom: 120px;}
/* --- ARTIST TRACKS PAGE (Sticky Banner & Follow Button) --- */
#tracksByArtistContainer {
    position: fixed;top: 0;left: 0;width: 100%;height: 100%;overflow-y: scroll;-webkit-overflow-scrolling: touch;background: var(--spotify-black);z-index: 5; padding-bottom: 60px;
}
.artist-page-header-sticky {position: sticky;top: 0;z-index: 15;background: transparent;transition: background-color 0.3s ease;}
#artistPageContent .artist-banner-area {height: 350px;box-shadow: inset 0 -150px 70px -50px rgba(0,0,0,0.7);transition: all 0.5s ease;}
#artistPageContent .artist-details-overlay {transition: opacity 0.3s ease;}
#artistPageContent .artist-details-overlay h2 {font-size: 32px;font-weight: 700;margin: 0;}
.back-btn-top { 
    position: absolute;top: 15px;left: 16px;z-index: 35;color: white;font-size: 24px;padding: 5px;cursor: pointer;
    background: rgba(0,0,0,0.3); border-radius: 50%;
    transition: background-color 0.3s ease;
}
.artist-action-bar {display:flex; justify-content:flex-end; padding: 16px; position: relative; z-index: 10;}
/* --- LIQUID GLASS: Artist Play Button --- */
.artist-play-btn {
    width: 56px; height: 56px; border-radius: 50%; background: var(--spotify-green); color: black; 
    display: flex; justify-content: center; align-items: center; font-size: 24px; border: none; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.4); cursor: pointer; position: absolute; right: 16px; top: -28px; 
    transition: transform 0.1s ease;
}
.artist-play-btn:active {transform: scale(0.95);}
.artist-other-controls {display:flex; align-items:center; gap: 15px; margin-right: auto; padding-top: 10px;}
.artist-other-controls button {
    padding: 6px 18px;border: 1px solid #b3b3b3; border-radius: 4px;background: transparent;
    color: white;font-size: 12px;font-weight: 700;cursor: pointer;
}
/* Mini Player & Nav */
/* --- LIQUID GLASS: Mini Player (FIXED: Dynamic color ready) --- */
.mini-player{
    position:fixed;bottom:60px;left:5px;right:5px;height:60px; /* Increased height for premium feel */
    border-radius:15px; /* Larger radius for liquid look */
    display:flex;align-items:center;padding:0 12px;z-index:50;cursor:pointer;
    transform:translateY(100%);
    transition:transform var(--transition-premium); /* Uses premium curve */
    /* Dynamic Glass Effect - Background color will be set by JS based on album art */
    background: rgba(40, 40, 40, 0.4); 
    backdrop-filter: blur(var(--glass-blur)) saturate(180%);
    -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(180%);
    box-shadow:0 8px 30px rgba(0,0,0,0.3); 
    border: 1px solid var(--glass-border-color);
}
.mini-player.active{transform:translateY(0);}
.mini-track-info{flex-grow:1;padding:0 10px;}
.mini-track-info h4{margin:0;font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mini-track-info p{margin:0;font-size:12px;color:var(--text-faded);}
.mini-controls button{
    background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:0 5px;
    transition: transform 0.1s ease;
}
.mini-controls button:active {transform: scale(0.95);}
/* --- LIQUID GLASS: Footer Nav Bar (New) --- */
.footer-nav{
    position:fixed;bottom:0;left:0;width:100%;height:60px;
    /* Premium Glass Effect */
    background: rgba(18, 18, 18, 0.65); /* Darker glass base */
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    display:flex;justify-content:space-around;align-items:center;z-index:55;
    padding-bottom:env(safe-area-inset-bottom);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}
.nav-item{color:var(--text-faded);display:flex;flex-direction:column;align-items:center;font-size:12px;padding-top:5px;cursor:pointer;}
.nav-item.active{color:white;}
/* FLAC/MP3 Switch Button (New UI) */
/* --- LIQUID GLASS: Format Switch Button --- */
#formatSwitchBtn {
    --button-size: 50px;
    position: fixed; bottom: 120px; right: 15px; /* Default position */
    width: var(--button-size); height: var(--button-size);
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15); 
    backdrop-filter: blur(var(--glass-blur)) brightness(1.2); 
    -webkit-backdrop-filter: blur(var(--glass-blur)) brightness(1.2);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    border: 1px solid var(--glass-border-color);
    color: white;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    font-size: 10px; font-weight: 700;
    z-index: 60; cursor: pointer;
    transition: transform 0.2s ease-out, background 0.3s ease, top 0s, left 0s, right 0s, bottom 0s; /* Position changes must be instant during drag */
}
#formatSwitchBtn:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.25); }
#formatSwitchBtn.format-mp3 { color: #ffcc00; } 
#formatSwitchBtn.format-flac { color: var(--spotify-green); }
@keyframes switch-anim { 0% { transform: rotateY(0deg); opacity: 1; } 50% { transform: rotateY(90deg); opacity: 0; } 100% { transform: rotateY(0deg); opacity: 1; } }
.switching-animation { animation: switch-anim 0.4s ease-in-out; }
/* Preloader/Spinner */
#preLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--spotify-black); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; transition: opacity 0.5s ease; }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--spotify-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
.small-spinner { display: inline-block; border: 3px solid #f3f3f3; border-top: 3px solid white; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="preLoader"><div class="spinner"></div><p>Totify is loading your music...</p></div>

<audio id="mainAudio" preload="auto"></audio> 

<div class="main-content">
    <div class="app-page" id="homePage"><div class="library-header"><span style="font-size: 30px;">ðŸ‘‹ Hello!</span></div><h2 style="padding: 0 16px;">It's New Music Friday!</h2><div style="height: 300px; background: #282828; margin: 16px; border-radius: 8px; display: flex; justify-content: center; align-items: center;"><p>Home Feed Content Placeholder</p></div></div>
    <div class="app-page" id="searchPage"><div class="search-header"><span class="title">Search</span><i class="fas fa-camera"></i></div><div class="search-bar"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="What do you want to listen to?"></div><ul class="track-list" id="searchResultsContainer"></ul><div class="browsing-section" id="browsingSection"><h3 class="start-browsing">Start browsing</h3><div class="browsing-grid"><div class="grid-item" style="background:linear-gradient(to bottom right, #AA1445, #E93F6A);">Music</div><div class="grid-item" style="background:linear-gradient(to bottom right, #1E8145, #38A169);">Podcasts</div><div class="grid-item" style="background:linear-gradient(to bottom right, #800080, #A020F0);">Live Events</div><div class="grid-item" style="background:linear-gradient(to bottom right, #005A9C, #0080C0);">Home of I-Pop</div></div><h3 class="start-browsing">Discover something new</h3><div style="height: 200px; background: #282828; margin: 16px; border-radius: 8px; display: flex; justify-content: center; align-items: center;"><p>Discovery Carousel Placeholder</p></div></div></div>
    <div class="app-page active" id="libraryPage"><div class="library-header" id="mainLibHeader"><span class="title">Your Library</span><div><i class="fas fa-search" id="librarySearchIcon" style="margin-right: 20px; cursor: pointer;"></i><i class="fas fa-plus" style="cursor: pointer;"></i></div></div><div class="library-filter-tabs" id="mainLibTabs"><div class="filter-tab active" data-content="playlists">Playlists</div><div class="filter-tab" data-content="artists">Artists</div></div><div class="library-controls" id="libraryControls"><div style="display:flex; align-items:center;"><i class="fas fa-arrow-up"></i><i class="fas fa-arrow-down" style="margin-right: 15px;"></i><span>Recents</span></div><i class="fas fa-th-large" style="margin-right: 0;"></i> </div><ul class="track-list" id="musicContainer"><div style="height: 100px; display: flex; justify-content: center; align-items: center; color: var(--text-faded);"><p>Loading Music...</p></div></ul><ul class="track-list" id="artistContainer" style="display:none;"></div><div id="tracksByArtistContainer" style="display:none;"></div><div id="likedSongsPlaylistContainer" style="display:none;"></div></div>
</div>

<div class="expanded-player" id="expandedPlayer">
    <div class="player-content-wrapper">
        <div class="player-header">
            <i class="fas fa-chevron-down" id="minimizeBtn"></i>
            <div class="playlist-indicator">PLAYING<br><span id="playerTitleSmall" style="color:white; font-size:14px;"></span></div>
            <i class="fas fa-ellipsis-v"></i>
        </div>
        <div class="player-art-container">
            <img class="player-art" id="playerArt" src="" alt="Album Art">
        </div>
        <div class="player-details">
            <div><h2 id="playerTrackTitle"></h2><p id="playerArtistName"></p></div>
            <i class="far fa-heart" id="likeBtn" style="color:white; font-size:24px; cursor:pointer;"></i>
        </div>
        <div class="progress-container">
            <input type="range" id="playerProgress" min="0" max="100" value="0">
            <div class="time-stamps"><span id="currentTime">0:00</span><span id="totalTime">0:00</span></div>
        </div>
        <div class="controls-row">
            <button id="shuffleBtn"><i class="fas fa-random"></i></button>
            <button id="prevBtn"><i class="fas fa-step-backward"></i></button>
            <button class="main-play" id="mainPlayBtn"><i class="fas fa-play"></i></button>
            <button id="nextBtn"><i class="fas fa-step-forward"></i></button>
            <button id="repeatBtn"><i class="fas fa-redo-alt"></i></button>
        </div>
        <div class="controls-row" style="font-size: 18px; margin-top: -10px; margin-bottom: 20px;">
            <button><i class="fas fa-volume-up"></i></button>
            <button><i class="fas fa-mobile-alt"></i></button>
            <button><i class="fas fa-share-alt"></i></button>
            <button id="downloadBtn"><i class="fas fa-download"></i></button> 
        </div>
        <div class="scrollable-content">
            <div class="artist-card-expanded">
                <div class="artist-banner-area" id="artistBannerArea">
                    <div class="artist-details-overlay">
                        <h2 id="expandedArtistName"></h2>
                        <p id="expandedMonthlyListeners">6.2 Cr monthly listeners</p>
                        <button class="follow-btn-large" id="bannerFollowBtn" style="align-self:flex-start;padding:10px 30px;border:1px solid white;border-radius:25px;color:white;background:none;font-weight:700;cursor:pointer;text-transform:uppercase;font-size:14px;margin-top:15px;">Follow</button>
                    </div>
                </div>
            </div>
            <h3 class="popular-title" style="padding:16px;font-size:20px;font-weight:700;margin-top:20px;margin-bottom:0;">Popular</h3>
            <ul class="track-list" id="artistPopularTracks"></ul>
            <div class="artist-pick-section"><h3 class="popular-title" style="padding:16px;font-size:20px;font-weight:700;margin-top:20px;margin-bottom:0;">Artist Pick</h3><div style="padding: 0 16px;"><div style="height: 100px; background: #282828; border-radius: 8px; display: flex; justify-content: center; align-items: center; color: var(--text-faded);"><p>Artist Pick Playlist Placeholder</p></div></div></div>
            <div style="height: 100px;"></div> 
        </div>
    </div>
</div>

<div class="mini-player" id="miniPlayer">
    <img id="miniArt" src="" alt="Album Art" class="track-img" style="width: 40px; height: 40px; border-radius: 2px;">
    <div class="mini-track-info"><h4 id="miniTitle"></h4><p id="miniArtist"></p></div>
    <div class="mini-controls"><button id="miniPlayBtn"><i class="fas fa-play"></i></button></div>
</div>

<div id="formatSwitchBtn" class="format-flac">
    <i class="fas fa-wave-square" style="font-size: 18px;"></i>
    <span class="icon-text">FLAC</span>
</div>

<div class="footer-nav">
    <div class="nav-item" data-page="homePage"><i class="fas fa-home"></i><span>Home</span></div>
    <div class="nav-item" data-page="searchPage"><i class="fas fa-search"></i><span>Search</span></div>
    <div class="nav-item active" data-page="libraryPage"><i class="fas fa-book"></i><span>Your Library</span></div>
    <div class="nav-item"><i class="fab fa-spotify"></i><span>Premium</span></div>
</div>
<script type="module">
// START JAVASCRIPT LOGIC (FIXED COLOR, NOTIFICATION & NAVIGATION)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC9rehsf-0jkb9dAeT1-0Z1C-yRJ0YI9dA", authDomain: "gymnm-ce84b.firebaseapp.com", projectId: "gymnm-ce84b",
    storageBucket: "gymnm-ce84b.appspot.com", messagingSenderId: "474926929394", appId: "1:474926929394:web:6abdb807caba2751a5c76b",
    measurementId: "G-6R9S8LYZNF"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Global State
let allTracks = []; let allArtists = new Map(); let currentTrackIndex = -1; 
const currentAudio = document.getElementById('mainAudio'); let isPlaying = false;   
let isLoading = false; let likedTrackIndexes = {}; let trackPlayCounts = {}; 
let currentFormat = localStorage.getItem('totify_audio_format') || 'flac'; 

// DOM Elements
const musicContainer = document.getElementById('musicContainer'); const artistContainer = document.getElementById('artistContainer');
const tracksByArtistContainer = document.getElementById('tracksByArtistContainer'); const likedSongsPlaylistContainer = document.getElementById('likedSongsPlaylistContainer');
const artistPopularTracksContainer = document.getElementById('artistPopularTracks'); const filterTabs = document.querySelectorAll('.library-filter-tabs .filter-tab');
const libraryControls = document.getElementById('libraryControls'); const expandedPlayer = document.getElementById('expandedPlayer');
const miniPlayer = document.getElementById('miniPlayer'); const mainPlayBtn = document.getElementById('mainPlayBtn');
const miniPlayBtn = document.getElementById('miniPlayBtn'); const footerNavItems = document.querySelectorAll('.nav-item');
const searchInput = document.getElementById('searchInput'); const searchResultsContainer = document.getElementById('searchResultsContainer');
const browsingSection = document.getElementById('browsingSection'); const scrollContentWrapper = document.querySelector('.player-content-wrapper');
const playerArt = document.getElementById('playerArt'); const playerHeader = document.querySelector('.player-header');
const playerProgress = document.getElementById('playerProgress'); const currentTimeDisplay = document.getElementById('currentTime');
const totalTimeDisplay = document.getElementById('totalTime'); const mainLibHeader = document.getElementById('mainLibHeader');
const mainLibTabs = document.getElementById('mainLibTabs'); const likeBtn = document.getElementById('likeBtn'); 
const formatSwitchBtn = document.getElementById('formatSwitchBtn');

// --- PWA SERVICE WORKER REGISTRATION ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(e => console.error('SW failed:', e));
  });
}

// --- FIXED DYNAMIC COLOR EXTRACTION ---
function updateDynamicColors(imgElement) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 10; canvas.height = 10;
    
    // Sample the center area of the image to get a true dominant color (avoiding green borders/defaults)
    ctx.drawImage(imgElement, imgElement.width / 4, imgElement.height / 4, imgElement.width / 2, imgElement.height / 2, 0, 0, 10, 10);
    const data = ctx.getImageData(0, 0, 10, 10).data;
    
    let r = 0, g = 0, b = 0;
    for (let i = 0; i < data.length; i += 4) {
        r += data[i]; g += data[i+1]; b += data[i+2];
    }
    r = Math.floor(r / (data.length / 4));
    g = Math.floor(g / (data.length / 4));
    b = Math.floor(b / (data.length / 4));

    const vibrantColor = `rgba(${r}, ${g}, ${b}, 0.8)`;
    const glassColor = `rgba(${r}, ${g}, ${b}, 0.5)`;
    
    miniPlayer.style.backgroundColor = glassColor;
    expandedPlayer.style.transition = "background 0.5s ease";
    expandedPlayer.style.background = `linear-gradient(to bottom, ${vibrantColor} 0%, #000 100%)`;
    document.querySelector('meta[name="theme-color"]').setAttribute('content', `rgb(${r}, ${g}, ${b})`);
}

// --- UTILITY & STATE FUNCTIONS ---
function hidePreLoader() {
    const preLoader = document.getElementById('preLoader');
    preLoader.style.opacity = '0';
    setTimeout(() => { preLoader.style.display = 'none'; }, 500);
}
function loadLikedData() {
    try {
        const storedLikes = localStorage.getItem('totify_liked_tracks');
        if (storedLikes) { likedTrackIndexes = JSON.parse(storedLikes); }
    } catch (e) { console.error("Error loading liked data:", e); }
}
function saveLikedData() {
    try {
        localStorage.setItem('totify_liked_tracks', JSON.stringify(likedTrackIndexes));
    } catch (e) { console.error("Error saving liked data:", e); }
}
function getArrayIndexOfTrack(trackIndex) { return allTracks.findIndex(t => t.index === trackIndex); }
function formatTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
}

function updatePlayButtonUI(state) {
    let icon;
    if (state === "loading") {
        icon = '<div class="spinner small-spinner"></div>'; isLoading = true;
    } else {
        icon = state === "play" ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>'; isLoading = false;
    }
    mainPlayBtn.innerHTML = icon; miniPlayBtn.innerHTML = icon; mainPlayBtn.disabled = isLoading;
    miniPlayBtn.disabled = isLoading; document.getElementById('nextBtn').disabled = isLoading;
    document.getElementById('prevBtn').disabled = isLoading;
    if ("mediaSession" in navigator && state !== "loading") {
        navigator.mediaSession.playbackState = state === "play" ? "paused" : "playing";
    }
}

function updateLikeButtonUI(trackIndex) {
    const isLiked = !!likedTrackIndexes[trackIndex];
    if (isLiked) {
        likeBtn.classList.remove('far'); likeBtn.classList.add('fas'); likeBtn.style.color = 'var(--spotify-green)';
    } else {
        likeBtn.classList.remove('fas'); likeBtn.classList.add('far'); likeBtn.style.color = 'white';
    }
}

function updatePlaylistView() {
    const containers = [musicContainer, searchResultsContainer, tracksByArtistContainer, likedSongsPlaylistContainer, artistPopularTracksContainer];
    containers.forEach(container => {
        if(!container) return;
        container.querySelectorAll('.track-item').forEach(item => {
            const index = parseInt(item.dataset.index);
            const isCurrentTrack = index === currentTrackIndex;
            item.classList.remove('playing');
            if (isCurrentTrack && isPlaying) { item.classList.add('playing'); }
        });
    });
}

// --- FIXED NOTIFICATION TIMING ---
function updateMediaNotification() {
    const currentTrack = allTracks.find(t => t.index === currentTrackIndex);
    if (!currentTrack) return;
    const notificationImage = currentTrack.image_base64 || "s512.png"; 
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: currentTrack.title, artist: currentTrack.artists.join(', '),    
            album: currentTrack.album || 'Totify', 
            artwork: [ { src: notificationImage, sizes: '512x512', type: 'image/jpeg' } ]
        });
        
        // FIX: Explicitly update position state for correct timing
        if ("setPositionState" in navigator.mediaSession) {
             navigator.mediaSession.setPositionState({
                 duration: currentAudio.duration || 0,
                 playbackRate: currentAudio.playbackRate || 1,
                 position: currentAudio.currentTime || 0
             });
        }
    }
}

function updateMediaSession() {
    if (!("mediaSession" in navigator)) return;
    navigator.mediaSession.setActionHandler("play", togglePlayPause);
    navigator.mediaSession.setActionHandler("pause", togglePlayPause);
    navigator.mediaSession.setActionHandler("nexttrack", nextTrack);
    navigator.mediaSession.setActionHandler("previoustrack", prevTrack);
    navigator.mediaSession.setActionHandler("seekto", (details) => {
        if (details.seekTime !== undefined) {
             currentAudio.currentTime = details.seekTime; 
             updateMediaNotification();
        }
    });
    updateMediaNotification();
}

function incrementPlayCount(trackIndex) {
    if (trackIndex === -1) return;
    trackPlayCounts[trackIndex] = (trackPlayCounts[trackIndex] || 0) + 1;
}

// --- FLAC/MP3 SWITCH LOGIC ---
const BTN_POSITION_KEY = 'totify_btn_position';
let isBtnDragging = false; 
function updateFormatButtonUI(format) {
    const textElement = formatSwitchBtn.querySelector('.icon-text');
    const iconElement = formatSwitchBtn.querySelector('i');
    formatSwitchBtn.classList.remove('format-flac', 'format-mp3');
    if (format === 'flac') {
        formatSwitchBtn.classList.add('format-flac'); textElement.textContent = 'FLAC'; iconElement.className = 'fas fa-wave-square';
    } else {
        formatSwitchBtn.classList.add('format-mp3'); textElement.textContent = 'MP3'; iconElement.className = 'fas fa-wifi';
    }
}
function switchAudioFormat() {
    if (isBtnDragging || isLoading) return;
    const newFormat = currentFormat === 'flac' ? 'mp3' : 'flac';
    formatSwitchBtn.classList.add('switching-animation');
    formatSwitchBtn.addEventListener('animationend', () => formatSwitchBtn.classList.remove('switching-animation'), { once: true });
    currentFormat = newFormat; localStorage.setItem('totify_audio_format', newFormat);
    updateFormatButtonUI(newFormat);
    if (currentTrackIndex !== -1) {
        const currentTime = currentAudio.currentTime; const wasPlaying = isPlaying;
        currentAudio.pause(); loadTrack(currentTrackIndex, wasPlaying, currentTime);
    }
}
function loadButtonPosition() {
    const savedPos = localStorage.getItem(BTN_POSITION_KEY);
    if (savedPos) {
        const { x, y } = JSON.parse(savedPos);
        formatSwitchBtn.style.left = x; formatSwitchBtn.style.top = y;
        formatSwitchBtn.style.right = 'auto'; formatSwitchBtn.style.bottom = 'auto';
    }
}
function saveButtonPosition() {
    const rect = formatSwitchBtn.getBoundingClientRect();
    localStorage.setItem(BTN_POSITION_KEY, JSON.stringify({ x: `${rect.left}px`, y: `${rect.top}px` }));
}

let dragStartX, dragStartY, initialLeft, initialTop;
const DRAG_TOLERANCE = 5;

formatSwitchBtn.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
        isBtnDragging = false; dragStartX = e.touches[0].clientX; dragStartY = e.touches[0].clientY;
        initialLeft = formatSwitchBtn.getBoundingClientRect().left; 
        initialTop = formatSwitchBtn.getBoundingClientRect().top;
        formatSwitchBtn.style.transition = 'none';
        document.addEventListener('touchmove', onTouchMove, { passive: false });
        document.addEventListener('touchend', onTouchEnd);
    }
}, { passive: true });
function onTouchMove(e) {
    if (e.touches.length === 1) {
        const deltaX = e.touches[0].clientX - dragStartX; const deltaY = e.touches[0].clientY - dragStartY;
        if (!isBtnDragging && (Math.abs(deltaX) > DRAG_TOLERANCE || Math.abs(deltaY) > DRAG_TOLERANCE)) { isBtnDragging = true; }
        if (isBtnDragging) {
            e.preventDefault();
            let newX = initialLeft + deltaX; let newY = initialTop + deltaY;
            newX = Math.max(0, Math.min(newX, window.innerWidth - formatSwitchBtn.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - formatSwitchBtn.offsetHeight));
            formatSwitchBtn.style.left = `${newX}px`; formatSwitchBtn.style.top = `${newY}px`;
            formatSwitchBtn.style.right = 'auto'; formatSwitchBtn.style.bottom = 'auto';
        }
    }
}
function onTouchEnd(e) {
    document.removeEventListener('touchmove', onTouchMove); document.removeEventListener('touchend', onTouchEnd);
    formatSwitchBtn.style.transition = 'transform 0.2s ease-out, background 0.3s ease, top 0.3s ease, left 0.3s ease, right 0.3s ease, bottom 0.3s ease';
    if (isBtnDragging) { 
        saveButtonPosition(); 
        const clickPreventionHandler = (evt) => {
            evt.stopPropagation();
            formatSwitchBtn.removeEventListener('click', clickPreventionHandler, true);
        };
        formatSwitchBtn.addEventListener('click', clickPreventionHandler, true);
    } 
    isBtnDragging = false;
}
window.addEventListener('load', loadButtonPosition);
formatSwitchBtn.addEventListener('click', switchAudioFormat);
updateFormatButtonUI(currentFormat);

// --- CORE PLAYBACK LOGIC ---
async function loadTrack(index, autoPlay = true, seekTime = 0) {
    const track = allTracks.find(t => t.index === index); if (!track) return;
    let sourceUrl = ""; const wasFLACMode = currentFormat === 'flac';
    if (wasFLACMode) { sourceUrl = track.flac_url || track.mp3_url; } else { sourceUrl = track.mp3_url || track.flac_url; }
    if (!sourceUrl) return;

    if (isPlaying) currentAudio.pause(); isPlaying = false; currentTrackIndex = index;
    const imageSource = track.image_base64 || "s512.png"; 
    const fullArtistList = track.artists.join(', ');    
    const primaryArtist = track.primaryArtist; 
    const artistData = allArtists.get(primaryArtist.toLowerCase());
    const artistImageSource = artistData ? artistData.image_base64_highres || artistData.image_base64 : ''; 
    
    playerArt.src = imageSource;
    // MATCH COLOR ON LOAD
    playerArt.onload = () => updateDynamicColors(playerArt);

    document.getElementById('playerTrackTitle').textContent = track.title;
    document.getElementById('playerArtistName').textContent = fullArtistList; 
    document.getElementById('playerTitleSmall').textContent = track.title;
    document.getElementById('miniArt').src = imageSource;
    document.getElementById('miniTitle').textContent = track.title;
    document.getElementById('miniArtist').textContent = fullArtistList;
    miniPlayer.classList.add('active'); 

    document.getElementById('expandedArtistName').innerHTML = `${primaryArtist} <i class="fas fa-check-circle" style="color:#3d94ff; font-size:16px;"></i>`;
    const artistBannerArea = document.getElementById('artistBannerArea');
    if (artistImageSource) {
         artistBannerArea.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.7)), url('${artistImageSource}')`;
         artistBannerArea.style.backgroundColor = 'transparent';
    } else {
         artistBannerArea.style.backgroundImage = 'none';
         artistBannerArea.style.backgroundColor = '#303030';
    }

    renderExpandedPlayerPopularTracks(primaryArtist); 
    playerProgress.value = 0; 
    currentTimeDisplay.textContent = formatTime(seekTime);
    totalTimeDisplay.textContent = formatTime(track.duration || 0); 
    
    updateMediaSession(); updateLikeButtonUI(index); updatePlaylistView();
    currentAudio.src = sourceUrl; currentAudio.load(); currentAudio.currentTime = seekTime; 
    
    if (autoPlay) {
        updatePlayButtonUI("loading"); 
        document.getElementById('expandedPlayer').classList.add('active'); 
        document.body.classList.add('lock-scroll'); 
        expandedPlayer.style.transform = ''; 
        scrollContentWrapper.scrollTop = 0;
        try { await currentAudio.play(); incrementPlayCount(index); } catch (e) { updatePlayButtonUI("play"); }
    } else { updatePlayButtonUI("play"); }
}

function togglePlayPause() {
    if (isLoading) return; 
    if (currentTrackIndex === -1 && allTracks.length > 0) { loadTrack(allTracks[0].index, true); return; }
    if (isPlaying) { currentAudio.pause(); } else { currentAudio.play().catch(e => console.error("Play failed:", e)); }
}

function nextTrack() {
    if (isLoading) return;
    const currentArrayIndex = getArrayIndexOfTrack(currentTrackIndex);
    if (currentArrayIndex === -1) return;
    let nextArrayIndex = (currentArrayIndex + 1) % allTracks.length;
    loadTrack(allTracks[nextArrayIndex].index, true);
}

function prevTrack() {
    if (isLoading) return;
    const currentArrayIndex = getArrayIndexOfTrack(currentTrackIndex);
    if (currentArrayIndex === -1) return;
    let prevArrayIndex = (currentArrayIndex - 1 + allTracks.length) % allTracks.length;
    loadTrack(allTracks[prevArrayIndex].index, true);
}

function seekTrack(progressValue) {
    if (isNaN(currentAudio.duration) || currentAudio.duration === 0) return;
    currentAudio.currentTime = (progressValue / 100) * currentAudio.duration;
    updateMediaNotification();
}

mainPlayBtn.addEventListener('click', togglePlayPause); miniPlayBtn.addEventListener('click', togglePlayPause);
document.getElementById('nextBtn').addEventListener('click', nextTrack); document.getElementById('prevBtn').addEventListener('click', prevTrack);
document.getElementById('minimizeBtn').addEventListener('click', () => {
    expandedPlayer.classList.remove('active'); document.body.classList.remove('lock-scroll'); expandedPlayer.style.transform = ''; 
});

miniPlayer.addEventListener('click', (e) => {
    if(e.target.closest('#miniPlayBtn')) return; 
    if (currentTrackIndex !== -1) {
        expandedPlayer.classList.add('active'); document.body.classList.add('lock-scroll'); expandedPlayer.style.transform = ''; 
    }
});

playerProgress.addEventListener('input', (e) => { seekTrack(e.target.value); });
likeBtn.addEventListener('click', (e) => {
    e.stopPropagation(); if (currentTrackIndex === -1) return;
    const newLikedState = !likeBtn.classList.contains('fas'); 
    if (newLikedState) {
        likeBtn.classList.remove('far'); likeBtn.classList.add('fas'); likeBtn.style.color = 'var(--spotify-green)';
        likedTrackIndexes[currentTrackIndex] = true;
    } else {
        likeBtn.classList.remove('fas'); likeBtn.classList.add('far'); likeBtn.style.color = 'white';
        delete likedTrackIndexes[currentTrackIndex]; 
    }
    saveLikedData(); renderLikedSongsCard(); 
});

currentAudio.addEventListener('loadedmetadata', () => {
    playerProgress.max = 100; totalTimeDisplay.textContent = formatTime(currentAudio.duration);
    updateMediaNotification();
});

currentAudio.addEventListener('timeupdate', () => {
    if(isNaN(currentAudio.duration) || currentAudio.duration === 0) return;
    playerProgress.value = (currentAudio.currentTime / currentAudio.duration) * 100;
    currentTimeDisplay.textContent = formatTime(currentAudio.currentTime);
});

currentAudio.addEventListener('playing', () => { isPlaying = true; updatePlayButtonUI("pause"); updatePlaylistView(); updateMediaNotification(); });
currentAudio.addEventListener('pause', () => { isPlaying = false; updatePlayButtonUI("play"); updatePlaylistView(); updateMediaNotification(); });
currentAudio.addEventListener('ended', nextTrack);

// --- UI NAVIGATION & RENDERING ---
function navigateToPage(pageId) {
    document.querySelectorAll('.app-page').forEach(page => page.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    footerNavItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === pageId) { item.classList.add('active'); }
    });
}
footerNavItems.forEach(item => {
    item.addEventListener('click', (e) => {
        const pageId = item.getAttribute('data-page');
        if (pageId) { navigateToPage(pageId); }
    });
});

function setActiveLibraryView(viewId) {
    musicContainer.style.display = 'none'; artistContainer.style.display = 'none';
    tracksByArtistContainer.style.display = 'none'; likedSongsPlaylistContainer.style.display = 'none'; 
    document.getElementById(viewId).style.display = 'block';
    libraryControls.style.visibility = viewId === 'musicContainer' ? 'visible' : 'hidden';
}

// FIXED: Navigation and filter tabs logic to maintain scroll/state
filterTabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
        const contentType = e.currentTarget.getAttribute('data-content');
        filterTabs.forEach(t => t.classList.remove('active'));
        e.currentTarget.classList.add('active');
        mainLibHeader.style.display = 'flex'; mainLibTabs.style.display = 'flex';
        if (contentType === 'artists') { showArtists(); } else { loadMusic(); }
    });
});

function createTrackListItem(data, containerType, trackNumber = null) {
    const item = document.createElement('li'); item.className = 'track-item';
    item.dataset.index = data.index; 
    let imageSource = data.image_base64 || "s512.png";
    const currentPlays = trackPlayCounts[data.index] || 0;
    const formattedPlays = new Intl.NumberFormat('en-US').format(currentPlays);
    
    if (containerType.includes('Popular') || containerType === 'artistTracks' || containerType === 'likedSongs') { 
        const displayNum = trackNumber !== null ? trackNumber : (data.index + 1);
        const artistNames = data.artists.join(', '); 
        const subtitleText = containerType === 'likedSongs' ? artistNames : `${formattedPlays} plays`;
        if (containerType === 'artistTracks' || containerType === 'likedSongs') { item.classList.add('artist-page-track'); }
        item.innerHTML = `
            <div class="track-number">${displayNum}</div>
            <div class="track-info"><h3>${data.title}</h3><p>${subtitleText}</p></div>
             <div class="track-controls"><i class="fas fa-check-circle check-icon"></i><i class="fas fa-ellipsis-v"></i></div>
        `;
    } else { 
        const artistNames = data.artists.join(', '); 
        item.innerHTML = `
            <img class="track-img" src="${imageSource}" alt="Album Art">
            <div class="track-info"><h3>${data.title}</h3><p>${artistNames}</p></div>
        `;
    }
    item.addEventListener('click', () => { loadTrack(data.index, true); });
    return item;
}

function renderLikedSongsCard() {
    let likedCount = Object.keys(likedTrackIndexes).length; let card = document.getElementById('likedSongsCard');
    if (!card) { card = document.createElement('li'); card.className = 'liked-songs-card'; card.id = 'likedSongsCard'; musicContainer.prepend(card); }
    const subtitleText = likedCount === 0 ? 'Save your favorites!' : `${likedCount} songs`;
    card.innerHTML = `
        <div class="liked-icon-container"><i class="fas fa-heart"></i></div>
        <div class="liked-songs-info"><h3>Liked Songs</h3><p>Playlist â€¢ ${subtitleText}</p></div>
    `;
    card.onclick = () => { renderLikedSongsPlaylist(); };
}

function loadMusic() {
    musicContainer.innerHTML = ''; renderLikedSongsCard();
    allTracks.forEach((data) => {
        musicContainer.appendChild(createTrackListItem(data, 'music'));
    });
    setActiveLibraryView('musicContainer'); updatePlaylistView();
}

function renderLikedSongsPlaylist() {
    setActiveLibraryView('likedSongsPlaylistContainer'); likedSongsPlaylistContainer.innerHTML = '';
    mainLibHeader.style.display = 'none'; mainLibTabs.style.display = 'none';
    const backBtn = document.createElement('div'); backBtn.className = 'back-btn-top'; backBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
    backBtn.onclick = () => { 
        likedSongsPlaylistContainer.style.display = 'none'; 
        mainLibHeader.style.display = 'flex'; mainLibTabs.style.display = 'flex'; 
        musicContainer.style.display = 'block'; 
    };
    likedSongsPlaylistContainer.appendChild(backBtn);
    const headerContent = document.createElement('div'); headerContent.className = 'fixed-header-content';
    const imageDiv = document.createElement('div'); imageDiv.className = 'liked-songs-image'; imageDiv.innerHTML = '<i class="fas fa-heart"></i>'; headerContent.appendChild(imageDiv);
    const metaDiv = document.createElement('div'); metaDiv.className = 'liked-songs-meta';
    metaDiv.innerHTML = `<h4>PLAYLIST</h4><h1>Liked Songs</h1><p>Your Library</p>`; headerContent.appendChild(metaDiv);
    likedSongsPlaylistContainer.appendChild(headerContent);
    const scrollLayer = document.createElement('div'); scrollLayer.className = 'playlist-content-scroll-layer';
    const likedTrackIndexesArray = Object.keys(likedTrackIndexes).map(index => parseInt(index));
    const likedTracks = allTracks.filter(t => likedTrackIndexesArray.includes(t.index)).sort((a, b) => b.index - a.index); 
    const listUl = document.createElement('ul'); listUl.className = 'track-list'; listUl.style.paddingBottom = '100px';
    if (likedTracks.length === 0) { listUl.innerHTML = `<li style="padding:16px; color:var(--text-faded);">No liked songs yet!</li>`; } 
    else { likedTracks.forEach((data, index) => { listUl.appendChild(createTrackListItem(data, 'likedSongs', index + 1)); }); }
    scrollLayer.appendChild(listUl); likedSongsPlaylistContainer.appendChild(scrollLayer);
}

function showArtists() {
    setActiveLibraryView('artistContainer'); artistContainer.innerHTML = '';
    const sortedArtists = Array.from(allArtists.values()).sort((a, b) => a.name.localeCompare(b.name));
    sortedArtists.forEach((data) => {
        const item = document.createElement('li'); item.className = 'artist-item';
        item.innerHTML = `<img class="artist-img" src="${data.image_base64 || 's512.png'}"><div class="artist-info"><h3>${data.name}</h3><p>Artist</p></div>`;
        item.addEventListener('click', () => { showTracksByArtist(data.name); });
        artistContainer.appendChild(item);
    });
}

// FIXED: Navigate back to artist list without resetting view
function showTracksByArtist(artistName) {
    tracksByArtistContainer.innerHTML = '';
    const artistData = allArtists.get(artistName.toLowerCase());
    const artistImage = artistData ? (artistData.image_base64_highres || artistData.image_base64) : "s512.png";
    const tracks = allTracks.filter(track => track.artists.some(artist => artist.toLowerCase() === artistName.toLowerCase()));
    setActiveLibraryView('tracksByArtistContainer'); mainLibHeader.style.display = 'none'; 
    mainLibTabs.style.display = 'none'; tracksByArtistContainer.scrollTop = 0; 
    const pageContent = document.createElement('div'); pageContent.id = 'artistPageContent';
    const backBtn = document.createElement('div'); backBtn.className = 'back-btn-top'; backBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
    backBtn.onclick = () => { 
        tracksByArtistContainer.style.display = 'none'; 
        mainLibHeader.style.display = 'none'; mainLibTabs.style.display = 'none'; 
        artistContainer.style.display = 'block'; 
        mainLibHeader.style.display = 'flex'; mainLibTabs.style.display = 'flex';
    };
    tracksByArtistContainer.appendChild(backBtn);
    const banner = document.createElement('div'); banner.className = 'artist-banner-area';
    banner.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.7)), url('${artistImage}')`;
    const bannerOverlay = document.createElement('div'); bannerOverlay.className = 'artist-details-overlay';
    bannerOverlay.innerHTML = `<h2>${artistName} <i class="fas fa-check-circle" style="color:#3d94ff; font-size:24px;"></i></h2><p>55.1L monthly listeners</p>`;
    banner.appendChild(bannerOverlay); pageContent.appendChild(banner); 
    const listUl = document.createElement('ul'); listUl.className = 'track-list'; listUl.style.paddingBottom = '100px'; 
    tracks.forEach((data, index) => { listUl.appendChild(createTrackListItem(data, 'artistTracks', index + 1)); });
    pageContent.appendChild(listUl); tracksByArtistContainer.appendChild(pageContent);
}

function renderExpandedPlayerPopularTracks(artistName) {
    const popularTracksContainer = document.getElementById('artistPopularTracks');
    popularTracksContainer.innerHTML = '';
    const tracks = allTracks.filter(track => track.primaryArtist.toLowerCase() === artistName.toLowerCase());
    tracks.slice(0, 6).forEach((data, index) => {
        popularTracksContainer.appendChild(createTrackListItem(data, 'expandedPlayerPopular', index + 1));
    });
}

searchInput.addEventListener('input', (e) => { 
    const query = e.target.value.toLowerCase().trim();
    if (query.length > 0) {
        browsingSection.classList.add('hidden');
        const filtered = allTracks.filter(t => t.title.toLowerCase().includes(query) || t.primaryArtist.toLowerCase().includes(query));
        renderSearchResults(filtered);
    } else {
        browsingSection.classList.remove('hidden'); searchResultsContainer.innerHTML = '';
    }
});

function renderSearchResults(results) {
    searchResultsContainer.innerHTML = '';
    results.forEach(data => searchResultsContainer.appendChild(createTrackListItem(data, 'search')));
}

// --- PLAYER DRAG LOGIC ---
let startX = 0; let startY = 0; let isVerticalDrag = false; let isHorizontalDrag = false;
const SWIPE_THRESHOLD_Y = 100; const SWIPE_THRESHOLD_X = 50;

document.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1 && expandedPlayer.classList.contains('active')) {
        startX = e.touches[0].clientX; startY = e.touches[0].clientY;
        isVerticalDrag = false; isHorizontalDrag = false;
        expandedPlayer.classList.add('is-dragging');
    }
}, { passive: true });

document.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1 && expandedPlayer.classList.contains('active')) {
        const deltaX = e.touches[0].clientX - startX;
        const deltaY = e.touches[0].clientY - startY;

        if (!isVerticalDrag && !isHorizontalDrag) {
            if (Math.abs(deltaY) > 10 && Math.abs(deltaY) > Math.abs(deltaX)) {
                if (scrollContentWrapper.scrollTop <= 0 && deltaY > 0) {
                    isVerticalDrag = true;
                }
            } else if (Math.abs(deltaX) > 10) {
                isHorizontalDrag = true;
            }
        }

        if (isVerticalDrag) {
            if (scrollContentWrapper.scrollTop <= 0) {
                if (e.cancelable) e.preventDefault();
                expandedPlayer.style.transform = `translateY(${Math.max(0, deltaY)}px)`;
            } else {
                isVerticalDrag = false;
                expandedPlayer.style.transform = 'translateY(0)';
            }
        }
    }
}, { passive: false });

document.addEventListener('touchend', (e) => {
    if (expandedPlayer.classList.contains('active')) {
        expandedPlayer.classList.remove('is-dragging');
        const deltaY = e.changedTouches[0].clientY - startY;
        const deltaX = startX - e.changedTouches[0].clientX;

        if (isVerticalDrag && deltaY > SWIPE_THRESHOLD_Y) {
            expandedPlayer.style.transform = 'translateY(100%)';
            setTimeout(() => {
                expandedPlayer.classList.remove('active');
                document.body.classList.remove('lock-scroll');
                expandedPlayer.style.transform = '';
            }, 300);
        } else {
            expandedPlayer.style.transform = 'translateY(0)';
        }

        if (isHorizontalDrag && Math.abs(deltaX) > SWIPE_THRESHOLD_X) {
            if (deltaX > 0) nextTrack(); else prevTrack();
        }
    }
    isVerticalDrag = false; isHorizontalDrag = false;
}, { passive: true });

scrollContentWrapper.addEventListener('scroll', () => {
    const scrollTop = scrollContentWrapper.scrollTop;
    const opacityFactor = Math.max(0, 1 - (scrollTop / 200));
    playerArt.style.transform = `scale(${Math.max(0.7, 1 - (scrollTop / 500))})`;
    playerArt.style.opacity = opacityFactor;
    playerHeader.style.backgroundColor = `rgba(18, 18, 18, ${Math.min(1, scrollTop / 150)})`;
});

// --- DATA LOADING ---
async function loadMusicAndArtists() {
    try {
         const musicSnapshot = await getDocs(collection(db, "music"));
         let index = 0;
         musicSnapshot.forEach(doc => {
             const data = doc.data();
             const artists = Array.isArray(data.artists) ? data.artists.map(a => a.name) : [data.artist || "Unknown"];
             allTracks.push({ ...data, index: index++, artists, primaryArtist: artists[0], duration: data.duration || 180 });
         });
         const artistSnapshot = await getDocs(collection(db, "artists"));
         artistSnapshot.forEach(doc => {
             const data = doc.data();
             allArtists.set(data.name.toLowerCase(), { ...data, image_base64_highres: data.image_base64 });
         });
         loadMusic(); hidePreLoader(); 
    } catch (error) { hidePreLoader(); }
}
loadLikedData(); loadMusicAndArtists();
</script>

</body>
</html>

