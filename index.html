<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta property="og:title" content="Totify">
<meta property="og:description" content="Listen to music like Spotify. Your music library and more.">
<meta property="og:image" content="s512.png"> 
<meta property="og:image:width" content="512">
<meta property="og:image:height" content="512">
<meta property="og:type" content="website">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Totify </title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<meta name="theme-color" content="#121212">
<style>
/* --- STYLES --- */
:root{
    --spotify-black: #121212;
    --spotify-dark-grey: #181818;
    --spotify-light-grey: #b3b3b3;
    --spotify-green: #1db954;
    --text-faded: #a7a7a7;
    --bg-darker: #000000;
}
/* REMOVE DEFAULT MOBILE TAP HIGHLIGHT COLOR */
* {
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
}
/* Ensure the body is set up for smooth mobile scrolling and layout */
body{margin:0;font-family:'Inter',sans-serif;background:var(--spotify-black);color:white;min-height:100vh; overflow-x: hidden; -webkit-overflow-scrolling: touch;}
.lock-scroll{overflow:hidden;position:fixed;width:100%;height:100%;}
.main-content{padding-bottom:120px;}
.app-page{display:none;min-height:100vh;}
.app-page.active{display:block;}
.library-header{display:flex;justify-content:space-between;align-items:center;padding:16px;padding-top:50px;font-size:24px;font-weight:700;}
.library-header .title{font-size:24px;font-weight:700;}
.library-filter-tabs{padding:8px 16px;display:flex;gap:10px;}
.filter-tab{padding:6px 12px;border:1px solid var(--text-faded);border-radius:20px;font-size:14px;cursor:pointer;color:white;}
.filter-tab.active{background:white;color:var(--spotify-black);border-color:white;}
.library-controls{display:flex;justify-content:space-between;align-items:center;padding:10px 16px;font-size:14px;color:var(--text-faded);}
.library-controls i{color:var(--text-faded);margin-right:5px;}
.track-list{list-style:none;padding:0;margin:0;}
.track-item{display:flex;align-items:center;padding:8px 16px;cursor:pointer;transition:background-color 0.1s ease;opacity:0;transform:translateY(10px);}
.track-item.show{opacity:1;transform:translateY(0);transition:opacity 0.3s ease-out,transform 0.3s ease-out;}
.track-item:hover{background-color:var(--spotify-dark-grey);}
.track-item.playing .track-info h3{color:var(--spotify-green);}
.track-img{width:50px;height:50px;object-fit:cover;margin-right:12px;border-radius:4px;}
.track-info{flex-grow:1;min-width:0;}
.track-info h3{margin:0;font-size:16px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.track-info p{margin:2px 0 0 0;font-size:13px;color:var(--text-faded);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.track-duration{font-size:13px;color:var(--text-faded);margin-right:15px;}
.track-item .track-duration{display:none;}
.artist-item{display:flex;align-items:center;padding:8px 16px;cursor:pointer;transition:background-color 0.1s ease;}
.artist-item:hover{background-color:var(--spotify-dark-grey);}
.artist-img{width:60px;height:60px;object-fit:cover;margin-right:12px;border-radius:50%;}
.artist-info{flex-grow:1;min-width:0;}
.artist-info h3{margin:0;font-size:16px;font-weight:600;}
.artist-info p{margin:2px 0 0 0;font-size:13px;color:var(--text-faded);}
.search-page{padding-bottom:0;}
.search-header{padding:16px;padding-top:50px;font-size:24px;font-weight:700;display:flex;justify-content:space-between;align-items:center;}
.search-bar{display:flex;align-items:center;background:white;color:var(--spotify-black);border-radius:6px;margin:0 16px 20px 16px;padding:10px;}
.search-bar i{font-size:18px;margin-right:10px;}
.search-bar input{border:none;outline:none;background:transparent;color:var(--spotify-black);font-size:16px;flex-grow:1;}
.start-browsing{padding:0 16px;}
.browsing-section.hidden{display:none;}
.browsing-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;padding:16px;}
.grid-item{height:100px;border-radius:8px;background:linear-gradient(to bottom right, #4CAF50, #2E8B57);padding:10px;font-weight:700;font-size:16px;overflow:hidden;position:relative;}
.grid-item:nth-child(1){background:linear-gradient(to bottom right, #AA1445, #E93F6A);} 
.grid-item:nth-child(2){background:linear-gradient(to bottom right, #1E8145, #38A169);} 
.grid-item:nth-child(3){background:linear-gradient(to bottom right, #800080, #A020F0);} 
.grid-item:nth-child(4){background:linear-gradient(to bottom right, #005A9C, #0080C0);} 

/* ORIGINAL PLAYER CSS & ANIMATIONS */
.expanded-player{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom, rgba(35, 120, 95, 0.9) 0%, var(--bg-darker) 100%);z-index:100;display:flex;flex-direction:column;padding:0;box-sizing:border-box;transition:transform 0.3s cubic-bezier(0.33, 1, 0.68, 1),background 0.5s ease;transform:translateY(100%);}
.expanded-player.is-dragging{transition:none;}
.expanded-player.active{transform:translateY(0);}
/* Apply smooth scrolling to the wrapper */
.player-content-wrapper{flex-grow:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:80px;}
.player-header,.player-details,.progress-container,.controls-row{padding-left:16px;padding-right:16px;width:100%;box-sizing:border-box;}
.player-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-top:20px;position:sticky;top:0;z-index:50;background-color:transparent;transition:background-color 0.1s ease-in;}
.player-header i{font-size:24px;cursor:pointer;}
.player-header .playlist-indicator{display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--text-faded);}
.player-art-container{display:flex;justify-content:center;align-items:center;padding-top:30px;padding-bottom:30px;padding-left:16px;padding-right:16px;}
.player-art{width:80vw;max-width:350px;aspect-ratio:1 / 1;border-radius:8px;box-shadow:0 10px 40px rgba(0,0,0,0.7);transition:all 0.2s ease-out;transform-origin:center center;}
.player-details{margin:0 0 20px 0;display:flex;justify-content:space-between;align-items:flex-end;}
/* FIX: Removed text-overflow ellipsis to show full title */
.player-details h2{margin:0;font-size:24px;font-weight:700; white-space: normal; overflow: visible; text-overflow: clip;}
.player-details p{margin:2px 0 0 0;font-size:16px;color:var(--text-faded); white-space: normal; overflow: visible; text-overflow: clip;}
.progress-container{margin-bottom:20px;}
.time-stamps{display:flex;justify-content:space-between;font-size:12px;color:var(--text-faded);margin-top:5px;}
.controls-row{display:flex;justify-content:space-around;align-items:center;font-size:24px;margin-bottom:20px;}
.controls-row button{background:none;border:none;color:white;cursor:pointer;padding:10px;outline:none;}
.controls-row .main-play{font-size:72px;}
input[type=range]{-webkit-appearance:none;width:100%;height:4px;border-radius:2px;background:#535353;outline:none;}
/* KEEP THUMB VISIBLE AT ALL TIMES FOR BETTER UX / FAST SEEK */
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:12px;height:12px;border-radius:50%;background:white;cursor:pointer; visibility: visible;} 
input[type=range]:not(:active)::-webkit-slider-thumb { visibility: visible; } 
input[type=range]:active::-webkit-slider-thumb { visibility: visible; }

/* --- LIKE BUTTON ANIMATION FIX --- */
.like-animation {
    animation: pulse 0.3s ease-in-out;
}
@keyframes pulse {
    0% { transform: scale(1.0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1.0); }
}

/* --- ARTIST PAGE STYLES --- */
.artist-card-expanded{background:transparent;margin:0;padding:0;overflow:hidden;border:none;}
.artist-banner-area{height:350px;position:relative;background-size:cover;background-position:center;background-repeat:no-repeat;display:flex;flex-direction:column;justify-content:flex-end;color:white;padding-left:16px;padding-right:16px;padding-bottom:10px;box-shadow:inset 0 -150px 70px -50px rgba(0,0,0,0.7);transition:background-image 0.5s ease;}
.artist-details-overlay{padding-top:10px;padding-bottom:20px;display:flex;flex-direction:column;gap:5px;transition:opacity 0.2s ease-out;}
.artist-details-overlay h2{font-size:32px;font-weight:700;margin:0;}
.artist-details-overlay p{font-size:16px;color:var(--text-faded);margin:0;}
.follow-btn-large{align-self:flex-start;padding:10px 30px;border:1px solid white;border-radius:25px;color:white;background:none;font-weight:700;cursor:pointer;text-transform:uppercase;font-size:14px;margin-top:15px;}
.lyrics-preview{text-align:center;padding:15px;background:rgba(30, 30, 30, 0.7);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:12px;margin:10px 16px;border:1px solid rgba(255, 255, 255, 0.1);}
.popular-title{padding:16px;font-size:20px;font-weight:700;margin-top:20px;margin-bottom:0;}

/* --- FIXES FOR POPULAR TRACKS LIST (Based on your image) --- */
#artistPopularTracks .track-item{
    /* Adjusted grid to give title/info column more space */
    display:grid;
    grid-template-columns:25px 1fr 40px; /* Number | Title/Plays | Controls */
    gap:15px; 
    padding:8px 16px;
}
#artistPopularTracks .track-item:hover{background-color:var(--spotify-dark-grey);}
#artistPopularTracks .track-item .track-img{display:none;} /* Ensure no image is displayed */
.track-number{font-size:16px;color:var(--text-faded);display:flex;align-items:center;justify-content:center;}
#artistPopularTracks .track-info{
    display:flex;
    flex-direction:column;
    justify-content:center;
    margin-right:0;
    min-width: 0; /* Ensures flexibility */
}
/* FIX 1: Allow Popular Track Title to WRAP and display fully (No ellipsis) */
#artistPopularTracks .track-info h3 {
    white-space: normal; 
    overflow: visible; 
    text-overflow: clip;
    line-height: 1.2;
}
/* FIX 2: Allow Popular Track Play Count to WRAP and display fully (No ellipsis) */
#artistPopularTracks .track-info p{
    font-size:13px;
    color:var(--text-faded);
    white-space: normal; 
    overflow: visible;
    text-overflow: clip;
}
.track-controls{display:flex;align-items:center;justify-content:flex-end;gap:10px;}
.track-controls i{color:var(--text-faded);font-size:18px;}
.track-controls .check-icon{color:var(--spotify-green);font-size:20px;}
#artistPopularTracks .track-duration{display:none;}
.artist-pick-section{margin-bottom:30px;}

/* LIKED SONGS ALBUM CARD */
.liked-songs-card {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    cursor: pointer;
    transition: background-color 0.1s ease;
}
.liked-songs-card:hover {
    background-color: var(--spotify-dark-grey);
}
.liked-icon-container {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #4A209B, #9C7CFD);
    border-radius: 4px;
    margin-right: 12px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
}
.liked-songs-info {
    flex-grow: 1;
}
.liked-songs-info h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
}
.liked-songs-info p {
    margin: 2px 0 0 0;
    font-size: 13px;
    color: var(--text-faded);
}


/* MINI PLAYER CSS & ANIMATION */
.mini-player{position:fixed;bottom:60px;left:5px;right:5px;height:55px;background:#404040;border-radius:8px;display:flex;align-items:center;padding:0 10px;z-index:50;cursor:pointer;transform:translateY(100%);transition:transform 0.3s ease-in-out;box-shadow:0 -2px 10px rgba(0,0,0,0.5);}
.mini-player.active{transform:translateY(0);}
.mini-track-info{flex-grow:1;padding:0 10px;}
.mini-track-info h4{margin:0;font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.mini-track-info p{margin:0;font-size:12px;color:var(--text-faded);}
.mini-controls button{background:none;border:none;color:white;font-size:24px;cursor:pointer;padding:0 5px;}
.mini-controls .mini-check{color:var(--spotify-green);font-size:22px;padding:0 8px;}
.footer-nav{position:fixed;bottom:0;left:0;width:100%;height:60px;background:rgba(18, 18, 18, 0.85);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);display:flex;justify-content:space-around;align-items:center;z-index:55;padding-bottom:env(safe-area-inset-bottom);}
.nav-item{color:var(--text-faded);display:flex;flex-direction:column;align-items:center;font-size:12px;padding-top:5px;cursor:pointer;}
.nav-item.active{color:white;}

/* --- ARTIST/LIKED SONGS PAGE STYLES --- */
#tracksByArtistContainer, #likedSongsPlaylistContainer {
    position: relative;
    width: 100%;
    padding: 0;
    margin: 0;
}
.fixed-header-content {
    padding-top: 50px;
    background-color: var(--spotify-black);
    display: flex;
    align-items: flex-end;
    padding-bottom: 20px;
}
.liked-songs-image {
    width: 200px;
    height: 200px;
    background: linear-gradient(135deg, #4A209B, #9C7CFD);
    margin: 0 16px;
    box-shadow: 0 4px 60px rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 96px;
}
.liked-songs-meta {
    padding-bottom: 20px;
}
.liked-songs-meta h4 {
    color: white;
    font-size: 14px;
    font-weight: 400;
    margin: 0;
}
.liked-songs-meta h1 {
    color: white;
    font-size: 48px;
    font-weight: 700;
    margin: 5px 0 10px 0;
}
.liked-songs-meta p {
    color: var(--text-faded);
    font-size: 14px;
    margin: 0;
}
.artist-header-fixed {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 40vh; /* Banner height */
    background-size: cover;
    background-position: center;
    z-index: 0; 
}
.artist-header-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to bottom, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.6) 100%);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 16px;
    box-sizing: border-box;
}
.artist-name-large {
    font-size: 48px;
    font-weight: 700;
    margin: 0;
    line-height: 1.1;
    text-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
.artist-listeners-count {
    font-size: 14px;
    color: #e0e0e0;
    margin-top: 8px;
    margin-bottom: 10px;
}
.artist-content-scroll-layer, .playlist-content-scroll-layer {
    position: relative;
    z-index: 1;
    margin-top: 35vh; /* Overlaps slightly */
    background: linear-gradient(to bottom, rgba(18,18,18,1) 0%, var(--spotify-black) 50px);
    min-height: 65vh;
    padding-bottom: 120px; /* Space for footer */
    box-shadow: 0 -20px 30px rgba(0,0,0,0.5);
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}
.playlist-content-scroll-layer {
    margin-top: 0;
    background: var(--spotify-black);
    padding-top: 20px;
    min-height: 50vh;
}
.artist-action-bar {
    display: flex;
    align-items: center;
    padding: 16px;
    position: relative;
}
.follow-btn-small {
    padding: 6px 18px;
    border: 1px solid white;
    border-radius: 4px;
    background: transparent;
    color: white;
    font-size: 12px;
    font-weight: 700;
    margin-right: 20px;
}
.artist-play-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--spotify-green);
    color: black;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    border: none;
    position: absolute;
    right: 16px;
    top: -28px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    cursor: pointer;
}
.back-btn-fixed {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 20; 
    width: 35px;
    height: 35px;
    background: rgba(0,0,0,0.5);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    color: white;
}
/* Style for tracks inside the artist page list */
.artist-page-track .track-item {
    display: grid;
    grid-template-columns: 25px 1fr 40px;
    gap: 10px;
    padding: 10px 16px;
}
.artist-page-track .track-item .track-img {
    display: none; 
}
/* FIX: Allow artist track list title to wrap, removing truncation */
.artist-page-track .track-item .track-info h3 {
    white-space: normal; 
    overflow: visible; 
    text-overflow: clip;
}

/* --- NEW PRELOADER STYLES & LOADING SPINNER --- */
#preLoader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: var(--spotify-black);
    z-index: 1000;
    display: flex; 
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 20px;
    transition: opacity 0.5s ease;
}
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--spotify-green);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}
.small-spinner {
    width: 24px;
    height: 24px;
    border-width: 3px;
    border-top: 3px solid white;
    animation: spin 0.8s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (min-width: 768px){
    .expanded-player{align-items:center;}
    .player-content-wrapper{max-width:500px;width:100%;}
    .player-header,.player-details,.progress-container,.controls-row{padding-left:0;padding-right:0;}
    .player-art{width:60vw;max-width:300px;}
}
</style>
</head>
<body>

<div id="preLoader">
    <div class="spinner"></div>
    <p>Totify is loading your music...</p>
</div>

<audio id="mainAudio" preload="auto"></audio> 

<div class="main-content">
    <div class="app-page" id="homePage">
        <div class="library-header">
             <span style="font-size: 30px;">ðŸ‘‹ Hello!</span>
        </div>
        <h2 style="padding: 0 16px;">It's New Music Friday!</h2>
        <div style="height: 300px; background: #282828; margin: 16px; border-radius: 8px; display: flex; justify-content: center; align-items: center;">
            <p>Home Feed Content Placeholder</p>
        </div>
    </div>
    <div class="app-page" id="searchPage">
        <div class="search-header">
            <span class="title">Search</span>
            <i class="fas fa-camera"></i>
        </div>
        <div class="search-bar">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="What do you want to listen to?">
        </div>
        <ul class="track-list" id="searchResultsContainer"></ul>
        <div class="browsing-section" id="browsingSection">
            <h3 class="start-browsing">Start browsing</h3>
            <div class="browsing-grid">
                <div class="grid-item">Music</div>
                <div class="grid-item">Podcasts</div>
                <div class="grid-item">Live Events</div>
                <div class="grid-item">Home of I-Pop</div>
            </div>
            <h3 class="start-browsing">Discover something new</h3>
            <div style="height: 200px; background: #282828; margin: 16px; border-radius: 8px; display: flex; justify-content: center; align-items: center;">
                <p>Discovery Carousel Placeholder</p>
            </div>
        </div>
    </div>
    <div class="app-page active" id="libraryPage">
        <div class="library-header" id="mainLibHeader">
            <span class="title">Your Library</span>
            <div><i class="fas fa-search" id="librarySearchIcon" style="margin-right: 20px; cursor: pointer;"></i><i class="fas fa-plus" style="cursor: pointer;"></i></div>
        </div>
        <div class="library-filter-tabs" id="mainLibTabs">
            <div class="filter-tab active" data-content="playlists">Playlists</div>
            <div class="filter-tab" data-content="albums">Albums</div>
            <div class="filter-tab" data-content="artists">Artists</div>
        </div>
        <div class="library-controls" id="libraryControls">
            <div style="display:flex; align-items:center;">
                <i class="fas fa-arrow-up"></i>
                <i class="fas fa-arrow-down" style="margin-right: 15px;"></i>
                <span>Recents</span>
            </div>
            <i class="fas fa-th-large" style="margin-right: 0;"></i> </div>
        <ul class="track-list" id="musicContainer">
            <div style="height: 100px; display: flex; justify-content: center; align-items: center; color: var(--text-faded);">
                <p>Loading Music...</p>
            </div>
        </ul>
        <ul class="track-list" id="artistContainer" style="display:none;"></ul>
        <div id="tracksByArtistContainer" style="display:none;"></div>
        <div id="likedSongsPlaylistContainer" style="display:none;"></div>
    </div>
</div>

<div class="expanded-player" id="expandedPlayer">
    <div class="player-content-wrapper">
        <div class="player-header">
            <i class="fas fa-chevron-down" id="minimizeBtn"></i>
            <div class="playlist-indicator">
                PLAYING FROM PLAYLIST<br>
                <span id="playerTitleSmall" style="color:white; font-size:14px;"></span>
            </div>
            <i class="fas fa-ellipsis-v"></i>
        </div>
        <div class="player-art-container">
            <img class="player-art" id="playerArt" src="" alt="Album Art">
        </div>
        <div class="player-details">
            <div>
                <h2 id="playerTrackTitle"></h2>
                <p id="playerArtistName"></p>
            </div>
            <i class="far fa-heart" id="likeBtn" style="color:white; font-size:24px; cursor:pointer;"></i>
        </div>
        <div class="progress-container">
            <input type="range" id="playerProgress" min="0" max="100" value="0">
            <div class="time-stamps">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
        </div>
        <div class="controls-row">
            <button id="shuffleBtn"><i class="fas fa-random"></i></button>
            <button id="prevBtn"><i class="fas fa-step-backward"></i></button>
            <button class="main-play" id="mainPlayBtn"><i class="fas fa-play"></i></button>
            <button id="nextBtn"><i class="fas fa-step-forward"></i></button>
            <button id="repeatBtn"><i class="fas fa-redo-alt"></i></button>
        </div>
        <div class="controls-row" style="font-size: 18px; margin-top: -10px; margin-bottom: 20px;">
            <button><i class="fas fa-volume-up"></i></button>
            <button><i class="fas fa-mobile-alt"></i></button>
            <button><i class="fas fa-share-alt"></i></button>
            <button id="downloadBtn"><i class="fas fa-download"></i></button> 
        </div>
        <div class="scrollable-content">
            <div class="artist-card-expanded">
                <div class="artist-banner-area" id="artistBannerArea">
                    <div class="artist-details-overlay">
                        <h2 id="expandedArtistName"></h2>
                        <p id="expandedMonthlyListeners"></p>
                        <button class="follow-btn-large">Follow</button>
                    </div>
                </div>
            </div>
            <h3 class="popular-title">Popular</h3>
            <ul class="track-list" id="artistPopularTracks"></ul>
            <div class="artist-pick-section">
                <h3 class="popular-title">Artist Pick</h3>
                <div style="padding: 0 16px;">
                    <div style="height: 100px; background: #282828; border-radius: 8px; display: flex; justify-content: center; align-items: center; color: var(--text-faded);">
                        <p>Artist Pick Playlist Placeholder</p>
                    </div>
                </div>
            </div>
            <div class="lyrics-preview">
                <p style="margin: 0; font-size: 14px; color: var(--spotify-light-grey);">Lyrics will appear here</p>
                <p style="font-size: 18px; font-weight: 700;">Scroll Down to Read!</p>
            </div>
            <div style="height: 100px;"></div> 
        </div>
    </div>
</div>

<div class="mini-player" id="miniPlayer">
    <img id="miniArt" src="" alt="Album Art" class="track-img" style="width: 40px; height: 40px; border-radius: 2px;">
    <div class="mini-track-info">
        <h4 id="miniTitle"></h4>
        <p id="miniArtist"></p>
    </div>
    <div class="mini-controls">
        <button class="mini-check"><i class="fas fa-check"></i></button>
        <button id="miniPlayBtn"><i class="fas fa-play"></i></button>
    </div>
</div>

<div class="footer-nav">
    <div class="nav-item" data-page="homePage">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </div>
    <div class="nav-item" data-page="searchPage">
        <i class="fas fa-search"></i>
        <span>Search</span>
    </div>
    <div class="nav-item active" data-page="libraryPage">
        <i class="fas fa-book"></i>
        <span>Your Library</span>
    </div>
    <div class="nav-item">
        <i class="fab fa-spotify"></i>
        <span>Premium</span>
    </div>
</div>

<script type="module">
// START JAVASCRIPT LOGIC (with final fixes and performance improvements)

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyC9rehsf-0jkb9dAeT1-0Z1C-yRJ0YI9dA",
    authDomain: "gymnm-ce84b.firebaseapp.com",
    projectId: "gymnm-ce84b",
    storageBucket: "gymnm-ce84b.appspot.com",
    messagingSenderId: "474926929394",
    appId: "1:474926929394:web:6abdb807caba2751a5c76b",
    measurementId: "G-6R9S8LYZNF"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Global State
let allTracks = [];
let allArtists = new Map();
let currentTrackIndex = -1; 
const currentAudio = document.getElementById('mainAudio'); 
let isPlaying = false;   
let isLoading = false; // NEW STATE: Track audio loading status
let likedTrackIndexes = {}; 
let trackPlayCounts = {}; 

// DOM Elements
const musicContainer = document.getElementById('musicContainer');
const artistContainer = document.getElementById('artistContainer');
const tracksByArtistContainer = document.getElementById('tracksByArtistContainer');
const likedSongsPlaylistContainer = document.getElementById('likedSongsPlaylistContainer');
const artistPopularTracksContainer = document.getElementById('artistPopularTracks'); 
const filterTabs = document.querySelectorAll('.library-filter-tabs .filter-tab');
const libraryControls = document.getElementById('libraryControls');
const expandedPlayer = document.getElementById('expandedPlayer');
const miniPlayer = document.getElementById('miniPlayer');
const mainPlayBtn = document.getElementById('mainPlayBtn');
const miniPlayBtn = document.getElementById('miniPlayBtn');
const footerNavItems = document.querySelectorAll('.nav-item');
const searchInput = document.getElementById('searchInput');
const searchResultsContainer = document.getElementById('searchResultsContainer');
const browsingSection = document.getElementById('browsingSection');
const scrollContentWrapper = document.querySelector('.player-content-wrapper');
const playerArt = document.getElementById('playerArt');
const playerHeader = document.querySelector('.player-header');
const playerProgress = document.getElementById('playerProgress');
const currentTimeDisplay = document.getElementById('currentTime');
const totalTimeDisplay = document.getElementById('totalTime');
const mainLibHeader = document.getElementById('mainLibHeader');
const mainLibTabs = document.getElementById('mainLibTabs');
const likeBtn = document.getElementById('likeBtn'); 

// --- UX FIX: PRE-LOADER FUNCTIONS ---
function hidePreLoader() {
    const preLoader = document.getElementById('preLoader');
    preLoader.style.opacity = '0';
    setTimeout(() => { preLoader.style.display = 'none'; }, 500);
}
// --- END PRE-LOADER FUNCTIONS ---

// --- LOCAL STORAGE DATA PERSISTENCE FUNCTIONS ---
function loadLikedData() {
    try {
        const storedLikes = localStorage.getItem('totify_liked_tracks');
        if (storedLikes) {
            likedTrackIndexes = JSON.parse(storedLikes);
        }
    } catch (e) {
        console.error("Error loading liked data from localStorage:", e);
    }
}
function saveLikedData() {
    try {
        localStorage.setItem('totify_liked_tracks', JSON.stringify(likedTrackIndexes));
    } catch (e) {
        console.error("Error saving liked data to localStorage:", e);
    }
}
// --- END LOCAL STORAGE FUNCTIONS ---

function getArrayIndexOfTrack(trackIndex) {
    return allTracks.findIndex(t => t.index === trackIndex);
}
function formatTime(seconds) {
    if (isNaN(seconds) || seconds < 0) return "0:00";
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
}

function updateTrackListItem(trackIndex) {
    const track = allTracks.find(t => t.index === trackIndex);
    if (!track) return;
    const containers = [musicContainer, searchResultsContainer, tracksByArtistContainer, likedSongsPlaylistContainer, artistPopularTracksContainer];
    
    // FIX 2: Use full number formatting for play counts
    const formattedPlays = new Intl.NumberFormat('en-US').format(trackPlayCounts[trackIndex] || 0);

    // Update the play count display everywhere
    containers.forEach(container => {
        if(!container) return;
        container.querySelectorAll(`.track-item[data-index="${trackIndex}"]`).forEach(item => {
            const playsElement = item.querySelector('.track-info p'); 
            if (playsElement && (item.closest('#artistPopularTracks') || item.closest('.artist-page-track') || item.closest('#likedSongsPlaylistContainer'))) {
                // Ensure only play counts on the artist/playlist pages get updated
                playsElement.textContent = `${formattedPlays} plays`;
            }
        });
    });
}

function incrementPlayCount(trackIndex) {
    if (trackIndex === -1) return;
    trackPlayCounts[trackIndex] = (trackPlayCounts[trackIndex] || 0) + 1;
    updateTrackListItem(trackIndex); 
}


function navigateToPage(pageId) {
    document.querySelectorAll('.app-page').forEach(page => {
        page.classList.remove('active');
    });
    document.getElementById(pageId).classList.add('active');
    footerNavItems.forEach(item => {
        item.classList.remove('active');
        if (item.getAttribute('data-page') === pageId) {
            item.classList.add('active');
        }
    });
    if (pageId === 'libraryPage' || pageId === 'searchPage') {
        if (allTracks.length === 0) {
            loadMusicAndArtists();
        }
    }
    if (pageId !== 'searchPage') {
        searchInput.value = '';
        searchResultsContainer.innerHTML = '';
        browsingSection.classList.remove('hidden');
    }
}

footerNavItems.forEach(item => {
    item.addEventListener('click', (e) => {
        const pageId = item.getAttribute('data-page');
        if (pageId) {
            navigateToPage(pageId);
        }
        if (e.clientY > (window.innerHeight - 115)) { 
            e.preventDefault(); 
        }
    });
});

function togglePlayPause() {
    if (isLoading) return; // Prevent action while track is loading
    
    if (currentTrackIndex === -1 && allTracks.length > 0) {
        loadTrack(allTracks[0].index, true); 
        return;
    }
    if (currentTrackIndex === -1) return;

    if (isPlaying) {
        currentAudio.pause();
        isPlaying = false;
        updatePlayButtonUI("play"); 
    } else {
        if (currentAudio.src) {
            // If already loaded, play immediately
            currentAudio.play().catch(e => console.error("Play failed:", e));
            isPlaying = true;
            updatePlayButtonUI("pause"); 
        } else {
             const track = allTracks.find(t => t.index === currentTrackIndex);
             if (track) loadTrack(track.index, true);
        }
    }
    updateMediaNotification();
    updatePlaylistView();
}

function seekTrack(progressValue) {
    if (isNaN(currentAudio.duration) || currentAudio.duration === 0) return;
    const seekTo = (progressValue / 100) * currentAudio.duration;
    currentAudio.currentTime = seekTo;
    
    if (!isPlaying) {
        currentAudio.play().catch(e => console.error("Seek play failed:", e));
        isPlaying = true;
        updatePlayButtonUI("pause");
        updateMediaNotification();
    }
}

// NEW FUNCTION: Updates the play/pause button to show play, pause, or loading spinner
function updatePlayButtonUI(state) {
    let icon;
    if (state === "loading") {
        icon = '<div class="spinner small-spinner"></div>';
        isLoading = true;
    } else {
        icon = state === "play" ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
        isLoading = false;
    }

    mainPlayBtn.innerHTML = icon;
    miniPlayBtn.innerHTML = icon;

    // Disable buttons when loading
    mainPlayBtn.disabled = isLoading;
    miniPlayBtn.disabled = isLoading;
    document.getElementById('nextBtn').disabled = isLoading;
    document.getElementById('prevBtn').disabled = isLoading;

    if ("mediaSession" in navigator && state !== "loading") {
        navigator.mediaSession.playbackState = state === "play" ? "paused" : "playing";
    }
}

function updateLikeButtonUI(trackIndex) {
    const isLiked = !!likedTrackIndexes[trackIndex];
    if (isLiked) {
        likeBtn.classList.remove('far');
        likeBtn.classList.add('fas');
        likeBtn.style.color = 'var(--spotify-green)';
    } else {
        likeBtn.classList.remove('fas');
        likeBtn.classList.add('far');
        likeBtn.style.color = 'white';
    }
}

function updateMediaNotification() {
    const currentTrack = allTracks.find(t => t.index === currentTrackIndex);
    if (!currentTrack) return;
    const notificationImage = currentTrack.image_base64 || "s512.png"; 
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: currentTrack.title,      
            artist: currentTrack.artists.join(', '),    
            album: currentTrack.album || 'Totify', 
            artwork: [
                { src: notificationImage, sizes: '512x512', type: 'image/jpeg' } 
            ]
        });
        if ("setPositionState" in navigator.mediaSession) {
             navigator.mediaSession.setPositionState({
                 duration: currentAudio.duration || 0,
                 playbackRate: currentAudio.playbackRate || 1,
                 position: currentAudio.currentTime
             });
        }
    }
}

function updateMediaSession(track, imageSrc) {
    if (!("mediaSession" in navigator)) return;
    navigator.mediaSession.setActionHandler("play", togglePlayPause);
    navigator.mediaSession.setActionHandler("pause", togglePlayPause);
    navigator.mediaSession.setActionHandler("nexttrack", nextTrack);
    navigator.mediaSession.setActionHandler("previoustrack", prevTrack);
    updateMediaNotification();
}

// OPTIMIZED loadTrack function
async function loadTrack(index, autoPlay = true) {
    const track = allTracks.find(t => t.index === index);
    if (!track) return;
    
    if (currentTrackIndex === index && currentAudio.src && !currentAudio.paused) {
        if (autoPlay && !isPlaying) { togglePlayPause(); }
        return;
    }
    
    if (isPlaying) currentAudio.pause();
    isPlaying = false; 
    currentTrackIndex = index;

    // Reset and Load
    currentAudio.src = ''; // Clear source
    currentAudio.load();  // Force audio element reset
    currentAudio.src = track.url; // Set new source
    
    updateLikeButtonUI(index); 

    const imageSource = track.image_base64 || "https://via.placeholder.com/200/181818/1db954?text=No+Album+Art";
    const fullArtistList = track.artists.join(', ');    
    const primaryArtist = track.primaryArtist;          
    const artistData = allArtists.get(primaryArtist.toLowerCase());
    const artistImageSource = artistData ? artistData.image_base64_highres || artistData.image_base64 : ''; 

    // Update Player Details (UI update is fast)
    playerArt.src = imageSource;
    document.getElementById('playerTrackTitle').textContent = track.title;
    document.getElementById('playerArtistName').textContent = fullArtistList;
    document.getElementById('playerTitleSmall').textContent = track.title;
    
    document.getElementById('miniArt').src = imageSource;
    document.getElementById('miniTitle').textContent = track.title;
    document.getElementById('miniArtist').textContent = fullArtistList;
    miniPlayer.classList.add('active'); 

    document.getElementById('expandedArtistName').innerHTML = `${primaryArtist} <i class="fas fa-check-circle" style="color:#3d94ff; font-size:16px;"></i>`;
    document.getElementById('expandedMonthlyListeners').textContent = '6.2Cr monthly listeners'; 
    const artistBannerArea = document.getElementById('artistBannerArea');
    if (artistImageSource) {
         artistBannerArea.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.2), rgba(0,0,0,0.7)), url('${artistImageSource}')`;
         artistBannerArea.style.backgroundColor = 'transparent';
    } else {
         artistBannerArea.style.backgroundImage = 'none';
         artistBannerArea.style.backgroundColor = '#303030';
    }
    
    renderExpandedPlayerPopularTracks(primaryArtist); 
    expandedPlayer.style.background = `linear-gradient(to bottom, rgba(35, 120, 95, 0.9) 0%, var(--bg-darker) 100%)`;
    
    playerProgress.value = 0;
    currentTimeDisplay.textContent = '0:00';
    totalTimeDisplay.textContent = formatTime(track.duration || 0); 
    updateMediaSession(track, imageSource);
    
    if (autoPlay) {
        updatePlayButtonUI("loading"); // Show loading spinner
        
        document.getElementById('expandedPlayer').classList.add('active'); 
        document.body.classList.add('lock-scroll'); 
        expandedPlayer.style.transform = ''; 
        scrollContentWrapper.scrollTop = 0;
        updatePlaylistView();
        
        // Wait for audio to be ready, then play
        try {
            await currentAudio.play();
            isPlaying = true;
            updatePlayButtonUI("pause"); 
            incrementPlayCount(index);
        } catch (e) {
            console.error("Autoplay failed:", e);
            isPlaying = false;
            updatePlayButtonUI("play");
        }
    } else {
        updatePlayButtonUI("play"); 
    }
}

function nextTrack() {
    if (isLoading) return;
    const currentArrayIndex = getArrayIndexOfTrack(currentTrackIndex);
    if (currentArrayIndex === -1) return;
    let nextArrayIndex = (currentArrayIndex + 1) % allTracks.length;
    const nextTrackData = allTracks[nextArrayIndex];
    if (nextTrackData) { loadTrack(nextTrackData.index, true); }
}
function prevTrack() {
    if (isLoading) return;
    const currentArrayIndex = getArrayIndexOfTrack(currentTrackIndex);
    if (currentArrayIndex === -1) return;
    let prevArrayIndex = (currentArrayIndex - 1 + allTracks.length) % allTracks.length;
    const prevTrackData = allTracks[prevArrayIndex];
    if (prevTrackData) { loadTrack(prevTrackData.index, true); }
}
function updatePlaylistView() {
    const containers = [musicContainer, searchResultsContainer, tracksByArtistContainer, likedSongsPlaylistContainer, artistPopularTracksContainer];
    containers.forEach(container => {
        if(!container) return;
        container.querySelectorAll('.track-item').forEach(item => {
            const index = parseInt(item.dataset.index);
            const isCurrentTrack = index === currentTrackIndex;
            item.classList.remove('playing');
            if (isCurrentTrack && isPlaying) {
                item.classList.add('playing');
            }
        });
    });
}

mainPlayBtn.addEventListener('click', togglePlayPause);
miniPlayBtn.addEventListener('click', togglePlayPause);
document.getElementById('nextBtn').addEventListener('click', nextTrack);
document.getElementById('prevBtn').addEventListener('click', prevTrack);
document.getElementById('minimizeBtn').addEventListener('click', () => {
    document.getElementById('expandedPlayer').classList.remove('active');
    document.body.classList.remove('lock-scroll');
    expandedPlayer.style.transform = ''; 
});
miniPlayer.addEventListener('click', (e) => {
    if(e.target.closest('#miniPlayBtn') || e.target.closest('.mini-check')) return; 
    if (currentTrackIndex !== -1) {
        expandedPlayer.classList.add('active');
        document.body.classList.add('lock-scroll');
        expandedPlayer.style.transform = ''; 
    }
});
playerProgress.addEventListener('input', (e) => {
    seekTrack(e.target.value);
});

// LIKE BUTTON ANIMATION AND PERSISTENCE (Confirmed working)
likeBtn.addEventListener('click', (e) => {
    e.stopPropagation(); 
    if (currentTrackIndex === -1) return;

    likeBtn.classList.add('like-animation');
    likeBtn.addEventListener('animationend', () => {
        likeBtn.classList.remove('like-animation');
    }, { once: true });

    const isCurrentlyLiked = likeBtn.classList.contains('fas'); 
    const newLikedState = !isCurrentlyLiked;

    if (newLikedState) {
        likeBtn.classList.remove('far');
        likeBtn.classList.add('fas');
        likeBtn.style.color = 'var(--spotify-green)';
        likedTrackIndexes[currentTrackIndex] = true;
    } else {
        likeBtn.classList.remove('fas');
        likeBtn.classList.add('far');
        likeBtn.style.color = 'white';
        delete likedTrackIndexes[currentTrackIndex]; 
    }
    
    saveLikedData(); 
    renderLikedSongsCard(); 
});
// END LIKE BUTTON FIX

// Audio event listeners (Optimized)
currentAudio.addEventListener('loadedmetadata', () => {
    playerProgress.max = 100;
    totalTimeDisplay.textContent = formatTime(currentAudio.duration);
    currentAudio.dispatchEvent(new Event('timeupdate')); 
});
currentAudio.addEventListener('timeupdate', () => {
    if(isNaN(currentAudio.duration) || currentAudio.duration === 0) return;
    const progress = (currentAudio.currentTime / currentAudio.duration) * 100;
    playerProgress.value = progress;
    currentTimeDisplay.textContent = formatTime(currentAudio.currentTime);
    totalTimeDisplay.textContent = formatTime(currentAudio.duration);
    if (isPlaying) updateMediaNotification(); 
});
currentAudio.addEventListener('playing', () => {
    isPlaying = true;
    updatePlayButtonUI("pause");
    updatePlaylistView();
});
currentAudio.addEventListener('pause', () => {
    isPlaying = false;
    updatePlayButtonUI("play");
    updatePlaylistView();
});
currentAudio.addEventListener('ended', nextTrack);

// NEW: Use the 'canplaythrough' event to signify the audio is buffered enough to play smoothly
currentAudio.addEventListener('canplaythrough', () => {
    if (isLoading && !isPlaying) {
        // This is primarily a backup check; the await currentAudio.play() handles the main logic
        // But we ensure the loading state is cleared if the audio is ready
        updatePlayButtonUI("play"); 
    }
});
currentAudio.addEventListener('waiting', () => {
    if (isPlaying) {
        updatePlayButtonUI("loading"); 
    }
});


function setActiveLibraryView(viewId) {
    musicContainer.style.display = 'none';
    artistContainer.style.display = 'none';
    tracksByArtistContainer.style.display = 'none';
    likedSongsPlaylistContainer.style.display = 'none'; 
    document.getElementById(viewId).style.display = 'block';
    libraryControls.style.visibility = viewId === 'musicContainer' || viewId === 'likedSongsPlaylistContainer' ? 'visible' : 'hidden';
}

filterTabs.forEach(tab => {
    tab.addEventListener('click', (e) => {
        const clickedTab = e.currentTarget; 
        const contentType = clickedTab.getAttribute('data-content');
        filterTabs.forEach(t => t.classList.remove('active'));
        clickedTab.classList.add('active');

        tracksByArtistContainer.style.display = 'none';
        likedSongsPlaylistContainer.style.display = 'none';
        mainLibHeader.style.display = 'flex';
        mainLibTabs.style.display = 'flex';
        
        if (contentType === 'artists') {
            showArtists();
        } else {
            setActiveLibraryView('musicContainer');
            loadMusic(); 
        }
    });
});

// OPTIMIZATION: Load all data once on startup
async function loadMusicAndArtists() {
    if (allTracks.length > 0) { 
        loadMusic(); 
        hidePreLoader();
        return; 
    }
    try {
         const musicSnapshot = await getDocs(collection(db, "music"));
         let tempTracks = [];
         const uniqueKeys = new Set();
         let index = 0;
         musicSnapshot.forEach(doc => {
             const data = doc.data();
             const title = data.title ? data.title.trim().toLowerCase() : '';
             const artistNames = (Array.isArray(data.artists) ? data.artists.map(a => a.name.trim()) : (data.artist || "Unknown").split(',').map(a => a.trim()));
             const primaryArtist = artistNames[0];
             const uniqueKey = `${title}|${primaryArtist.toLowerCase()}`;
             if (uniqueKey && uniqueKeys.has(uniqueKey)) return;
             uniqueKeys.add(uniqueKey);
             const mockPlayCount = Math.floor(Math.random() * 2000000000) + 500000;
             tempTracks.push({ 
                 ...data, id: doc.id, index: index++, play_count: data.play_count || mockPlayCount, 
                 artists: artistNames, primaryArtist: primaryArtist, duration: data.duration || 180
             });
         });
         allTracks = tempTracks; 
         
         allTracks.forEach(t => {
             trackPlayCounts[t.index] = t.play_count;
         });

         const artistSnapshot = await getDocs(collection(db, "artists"));
         artistSnapshot.forEach(doc => {
             const data = doc.data();
             allArtists.set(data.name.toLowerCase(), { image_base64_highres: data.image_base64, ...data });
         });
         
         loadMusic();
         hidePreLoader(); 
    } catch (error) { 
        console.error("Error loading Firebase data:", error); 
        hidePreLoader(); 
    }
}

function createTrackListItem(data, containerType, trackNumber = null) {
    const item = document.createElement('li');
    item.className = 'track-item';
    item.dataset.index = data.index; 
    let imageSource = data.image_base64 || "https://via.placeholder.com/50/121212/FFFFFF?text=A";
    
    // FIX 2: Use full number formatting for play counts
    const currentPlays = trackPlayCounts[data.index] || data.play_count || 0;
    const formattedPlays = new Intl.NumberFormat('en-US').format(currentPlays);

    if (containerType === 'expandedPlayerPopular' || containerType === 'artistTracks' || containerType === 'likedSongs') { 
        const displayNum = trackNumber !== null ? trackNumber : (data.index + 1);
        const artistNames = data.artists.join(', '); 
        const subtitleText = containerType === 'likedSongs' ? artistNames : `${formattedPlays} plays`;

        item.innerHTML = `
            <div class="track-number">${displayNum}</div>
            <div class="track-info"><h3>${data.title}</h3><p>${subtitleText}</p></div>
             <div class="track-controls"><i class="fas fa-check-circle check-icon"></i><i class="fas fa-ellipsis-v"></i></div>
        `;
    } else { 
        const artistNames = data.artists.join(', '); 
        item.innerHTML = `
            <img class="track-img" src="${imageSource}" alt="Album Art">
            <div class="track-info"><h3>${data.title}</h3><p>${artistNames}</p></div>
        `;
    }
    item.addEventListener('click', () => { loadTrack(data.index, true); });
    if (containerType !== 'search') { item.style.opacity = 1; item.style.transform = 'translateY(0)'; }
    return item;
}

// Render Liked Songs Card in Library
function renderLikedSongsCard() {
    let likedCount = Object.keys(likedTrackIndexes).length;
    let card = document.getElementById('likedSongsCard');
    if (!card) {
        card = document.createElement('li');
        card.className = 'liked-songs-card';
        card.id = 'likedSongsCard';
        musicContainer.prepend(card);
    }
    
    const subtitleText = likedCount === 0 
        ? 'Save your favorites!' 
        : `${likedCount} songs`;

    card.innerHTML = `
        <div class="liked-icon-container"><i class="fas fa-heart"></i></div>
        <div class="liked-songs-info">
            <h3>Liked Songs</h3>
            <p>Playlist â€¢ ${subtitleText}</p>
        </div>
    `;

    card.onclick = () => { renderLikedSongsPlaylist(); };
}

function loadMusic() {
    musicContainer.innerHTML = '';
    renderLikedSongsCard(); // Ensure card is first element
    allTracks.forEach((data) => {
        const item = createTrackListItem(data, 'music');
        musicContainer.appendChild(item);
    });
    updatePlaylistView();
}

// Render Liked Songs Playlist Page
function renderLikedSongsPlaylist() {
    setActiveLibraryView('likedSongsPlaylistContainer');
    likedSongsPlaylistContainer.innerHTML = '';

    const backBtn = document.createElement('div');
    backBtn.className = 'back-btn-fixed';
    backBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
    backBtn.onclick = () => {
        likedSongsPlaylistContainer.style.display = 'none';
        mainLibHeader.style.display = 'flex';
        mainLibTabs.style.display = 'flex';
        setActiveLibraryView('musicContainer');
    };
    likedSongsPlaylistContainer.appendChild(backBtn);

    const headerContent = document.createElement('div');
    headerContent.className = 'fixed-header-content';

    const imageDiv = document.createElement('div');
    imageDiv.className = 'liked-songs-image';
    imageDiv.innerHTML = '<i class="fas fa-heart"></i>';
    headerContent.appendChild(imageDiv);

    const metaDiv = document.createElement('div');
    metaDiv.className = 'liked-songs-meta';
    metaDiv.innerHTML = `
        <h4>PLAYLIST</h4>
        <h1>Liked Songs</h1>
        <p>Your Name</p>
    `;
    headerContent.appendChild(metaDiv);
    likedSongsPlaylistContainer.appendChild(headerContent);

    const scrollLayer = document.createElement('div');
    scrollLayer.className = 'playlist-content-scroll-layer';

    const likedTrackIndexesArray = Object.keys(likedTrackIndexes).map(index => parseInt(index));
    const likedTracks = allTracks
        .filter(t => likedTrackIndexesArray.includes(t.index))
        .sort((a, b) => b.index - a.index); 

    const listUl = document.createElement('ul');
    listUl.className = 'track-list artist-page-track';
    listUl.style.paddingBottom = '100px';

    if (likedTracks.length === 0) {
        listUl.innerHTML = `<li style="padding:16px; color:var(--text-faded);">No liked songs yet!</li>`;
    } else {
        likedTracks.forEach((data, index) => {
            const item = createTrackListItem(data, 'likedSongs', index + 1); 
            listUl.appendChild(item);
        });
    }
    scrollLayer.appendChild(listUl);
    likedSongsPlaylistContainer.appendChild(scrollLayer);
}


function createArtistListItem(artistData) {
    const item = document.createElement('li');
    item.className = 'artist-item';
    const artistName = artistData.name;
    const imageSource = artistData.image_base64 || "https://via.placeholder.com/60/121212/FFFFFF?text=A";
    item.innerHTML = `<img class="artist-img" src="${imageSource}"><div class="artist-info"><h3>${artistName}</h3><p>Artist</p></div>`;
    item.addEventListener('click', () => { showTracksByArtist(artistName); });
    return item;
}

function showArtists() {
    setActiveLibraryView('artistContainer');
    artistContainer.innerHTML = '';
    Array.from(allArtists.values()).forEach((data) => {
        artistContainer.appendChild(createArtistListItem(data));
    });
}

function showTracksByArtist(artistName) {
    tracksByArtistContainer.innerHTML = '';
    
    const artistData = allArtists.get(artistName.toLowerCase());
    const artistImage = artistData ? (artistData.image_base64_highres || artistData.image_base64) : "s512.png";
    const tracks = allTracks.filter(track => 
        track.artists.some(artist => artist.toLowerCase() === artistName.toLowerCase())
    );

    setActiveLibraryView('tracksByArtistContainer');
    mainLibHeader.style.display = 'none';
    mainLibTabs.style.display = 'none';

    const backBtn = document.createElement('div');
    backBtn.className = 'back-btn-fixed';
    backBtn.innerHTML = '<i class="fas fa-arrow-left"></i>';
    backBtn.onclick = () => {
        tracksByArtistContainer.style.display = 'none';
        mainLibHeader.style.display = 'flex';
        mainLibTabs.style.display = 'flex';
        showArtists();
    };
    tracksByArtistContainer.appendChild(backBtn);

    const fixedHeader = document.createElement('div');
    fixedHeader.className = 'artist-header-fixed';
    fixedHeader.style.backgroundImage = `url('${artistImage}')`;
    
    const overlay = document.createElement('div');
    overlay.className = 'artist-header-overlay';
    overlay.innerHTML = `
        <h1 class="artist-name-large">${artistName} <i class="fas fa-check-circle" style="color:#3d94ff; font-size:24px;"></i></h1>
        <div class="artist-listeners-count">55.1L monthly listeners</div>
    `;
    fixedHeader.appendChild(overlay);
    tracksByArtistContainer.appendChild(fixedHeader);

    const scrollLayer = document.createElement('div');
    scrollLayer.className = 'artist-content-scroll-layer';

    const actionBar = document.createElement('div');
    actionBar.className = 'artist-action-bar';
    actionBar.innerHTML = `
        <button class="follow-btn-small">Follow</button>
        <i class="fas fa-ellipsis-v" style="color: #b3b3b3; font-size: 20px;"></i>
        <button class="artist-play-btn"><i class="fas fa-play"></i></button>
    `;
    actionBar.querySelector('.artist-play-btn').addEventListener('click', () => {
        if(tracks.length > 0) loadTrack(tracks[0].index, true);
    });
    scrollLayer.appendChild(actionBar);

    const popTitle = document.createElement('h3');
    popTitle.className = 'popular-title';
    popTitle.textContent = 'Popular';
    scrollLayer.appendChild(popTitle);

    const listUl = document.createElement('ul');
    listUl.className = 'track-list artist-page-track';
    listUl.style.paddingBottom = '100px';

    if (tracks.length === 0) {
        listUl.innerHTML = `<li style="padding:16px; color:var(--text-faded);">No songs found.</li>`;
    } else {
        tracks.forEach((data, index) => {
            const item = createTrackListItem(data, 'artistTracks', index + 1); 
            listUl.appendChild(item);
        });
    }
    scrollLayer.appendChild(listUl);
    tracksByArtistContainer.appendChild(scrollLayer);
}

function renderExpandedPlayerPopularTracks(artistName) {
    const popularTracksContainer = document.getElementById('artistPopularTracks');
    popularTracksContainer.innerHTML = '';
    const tracks = allTracks.filter(track => track.primaryArtist.toLowerCase() === artistName.toLowerCase());
    const dedupedTracks = [];
    const seenTitles = new Set();
    const sortedTracks = tracks.sort((a, b) => (trackPlayCounts[b.index] || b.play_count || 0) - (trackPlayCounts[a.index] || a.play_count || 0));
    sortedTracks.forEach(track => {
        const key = track.title.trim().toLowerCase();
        if (!seenTitles.has(key)) { seenTitles.add(key); dedupedTracks.push(track); }
    });
    const popular = dedupedTracks.slice(0, 6);
    popular.forEach((data, index) => {
        const item = createTrackListItem(data, 'expandedPlayerPopular', index + 1);
        popularTracksContainer.appendChild(item);
    });
}

function calculateScore(track, query) {
    let score = 0;
    const lowerQuery = query.toLowerCase();
    const title = track.title.toLowerCase();
    if (title.startsWith(lowerQuery)) { score += 10; } else if (title.includes(lowerQuery)) { score += 5; }
    const primaryArtist = track.primaryArtist.toLowerCase();
    if (primaryArtist.startsWith(lowerQuery)) { score += 8; } else if (primaryArtist.includes(lowerQuery)) { score += 4; }
    if (track.album && track.album.toLowerCase().startsWith(lowerQuery)) { score += 3; }
    score += (track.play_count / 10000000000); 
    return score;
}

function renderSearchResults(results) {
    searchResultsContainer.innerHTML = '';
    if (results.length === 0) { searchResultsContainer.innerHTML = `<li style="padding: 16px; color: var(--text-faded);">No relevant results found.</li>`; return; }
    results.forEach((data, i) => {
        const item = createTrackListItem(data, 'search');
        setTimeout(() => { item.classList.add('show'); }, i * 50); 
        searchResultsContainer.appendChild(item);
    });
    updatePlaylistView();
}

searchInput.addEventListener('input', async (e) => { 
    const query = e.target.value.toLowerCase().trim();
    if (allTracks.length === 0) { await loadMusicAndArtists(); }
    if (query.length > 0) {
        browsingSection.classList.add('hidden');
        const scoredTracks = allTracks.map(track => ({ ...track, score: calculateScore(track, query) })).filter(track => track.score > 0);
        scoredTracks.sort((a, b) => b.score - a.score);
        renderSearchResults(scoredTracks);
    } else {
        browsingSection.classList.remove('hidden');
        searchResultsContainer.innerHTML = '';
    }
});

let startX = 0;
let startY = 0;
let isDragging = false;
let isVerticalDrag = false;
let isHorizontalDrag = false;
const SWIPE_THRESHOLD_Y = 100; 
const SWIPE_THRESHOLD_X = 50; 

document.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1 && expandedPlayer.classList.contains('active')) {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isDragging = false;
        isVerticalDrag = false;
        isHorizontalDrag = false;
        expandedPlayer.classList.add('is-dragging');
        
        // Use passive: false selectively on the expanded player to prevent default scroll
        // only when starting near the edges or the top of the content area.
        if (startY < 50 || (scrollContentWrapper.scrollTop === 0 && startY < (window.innerHeight / 2))) {
            // Prevent default scroll when starting a drag near the top
             e.preventDefault();
        }
    }
}, { passive: false });

document.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1 && expandedPlayer.classList.contains('active')) {
        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const deltaX = currentX - startX;
        const deltaY = currentY - startY;
        const absDeltaX = Math.abs(deltaX);
        const absDeltaY = Math.abs(deltaY);
        
        if (!isDragging) {
             if (absDeltaY > 10 || absDeltaX > 10) {
                 isDragging = true;
                 if (absDeltaY > absDeltaX) {
                     isVerticalDrag = true;
                 } else {
                     isHorizontalDrag = true;
                 }
             }
        }

        if (isVerticalDrag) {
            if (scrollContentWrapper.scrollTop === 0) {
                 if (deltaY > 0) {
                     // Dragging down to minimize
                     expandedPlayer.style.transform = `translateY(${Math.max(0, deltaY)}px)`;
                     e.preventDefault(); 
                 } else if (deltaY < 0) {
                     // Dragging up to scroll content
                     isVerticalDrag = false; 
                     expandedPlayer.style.transform = 'translateY(0)';
                     expandedPlayer.classList.remove('is-dragging');
                 }
            } else {
                // Let the wrapper scroll
                isVerticalDrag = false; 
                expandedPlayer.classList.remove('is-dragging');
            }
        } else if (isHorizontalDrag) {
             // Let next/prev track swipe happen without scrolling the page
             e.preventDefault();
        }
    }
}, { passive: false });

document.addEventListener('touchend', (e) => {
    if (expandedPlayer.classList.contains('active')) {
        expandedPlayer.classList.remove('is-dragging');
        
        const endY = e.changedTouches[0].clientY;
        const deltaX = startX - e.changedTouches[0].clientX;
        const deltaY = endY - startY;
        const absDeltaX = Math.abs(deltaX);

        if (isVerticalDrag) {
            if (deltaY > SWIPE_THRESHOLD_Y) {
                expandedPlayer.style.transform = 'translateY(100%)';
                expandedPlayer.addEventListener('transitionend', function handler() {
                    expandedPlayer.classList.remove('active');
                    document.body.classList.remove('lock-scroll');
                    expandedPlayer.style.transform = ''; 
                    expandedPlayer.removeEventListener('transitionend', handler);
                }, { once: true });
            } else {
                expandedPlayer.style.transform = 'translateY(0)';
            }
        } else if (isHorizontalDrag && absDeltaX > SWIPE_THRESHOLD_X) {
            if (deltaX > 0) { nextTrack(); } else { prevTrack(); }
        }
    }
    isDragging = false;
    isVerticalDrag = false;
    isHorizontalDrag = false;
}, { passive: true }); 

const maxScroll = 250;
function updateCollapsibleHeader() {
    const scrollTop = scrollContentWrapper.scrollTop;
    const scaleFactor = Math.max(0.7, 1 - (scrollTop / maxScroll) * 0.3); 
    const opacityFactor = Math.max(0, 1 - (scrollTop / (maxScroll * 0.8)));
    playerArt.style.transform = `scale(${scaleFactor})`;
    playerArt.style.opacity = opacityFactor;
    const headerOpacity = Math.min(1, scrollTop / 150); 
    playerHeader.style.backgroundColor = `rgba(18, 18, 18, ${headerOpacity})`;
    const artistDetailsOverlay = document.querySelector('.artist-details-overlay');
    if (artistDetailsOverlay) {
        const bannerOpacity = Math.max(0, 1 - (scrollTop / 100));
        artistDetailsOverlay.style.opacity = bannerOpacity;
    }
}
scrollContentWrapper.addEventListener('scroll', updateCollapsibleHeader);

loadLikedData();
loadMusicAndArtists();

// END JAVASCRIPT LOGIC
</script>
</body>
</html>
